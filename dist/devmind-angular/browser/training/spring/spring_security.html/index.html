<!DOCTYPE html><html lang="en" data-critters-container><head>
  <meta charset="utf-8">
  <title>Training</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      min-height: 100vh;
      max-height: 100vh;
      font-family: "Helvetica", "Arial", "sans-serif";
      padding: 0;
      margin: 0;
    }

    header {
      height: 90px;
      max-height: 90px;
      box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      background-color: white;
      display: -webkit-flex;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 99;
      transition-duration: 0.2s;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-property: max-height, box-shadow;
      position: fixed;
      width: 100%;
      text-align: center;
    }
    header hr {
      width:100%;
      background-color: #424242;
      border-color: #424242;
      display: block;
      border: 0;
      height: 0.5em;
      margin: 0;
    }
    .header-img {
      margin: auto;
      width: 50%;
      padding-top: 0.5em;
      height: 30px;
    }
    .header-img img {
      max-height: 30px !important;
    }
    .header-space {
      min-height: 90px;
    }


    @media screen and (min-width: 901px) {
      header {
        height: 120px;
        max-height: 120px;
      }
      .header-img {
        height: 60px;
      }
      .header-img img {
        max-height: 60px !important;
      }
      .header-space {
        min-height: 120px;
      }
      nav a {
        padding: 6px 24px;
      }
      .nav-home{
        display: block !important;
      }
    }


    nav {
      display: -webkit-flex;
      display: flex;
      margin: auto;
    }

    nav a {
      padding: 0 12px;
      line-height: 28px;
      height: 28px;
      color: #424242;
      margin: auto;
      text-decoration: none;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 13px;
      border-radius: 4px;
    }
    .nav-home{
      display: none;
    }
    nav a > img {
    // height: 20px;
    }

    nav a:hover {
      background-color: #9e9e9e;
    }

    nav .active {
      background-color: rgba(0, 0, 0, 0.14);
    }

    main {
      overflow-x: hidden;
    }

    img, picture {
      max-width: 100%;
      height: auto;
      margin: auto;
    }

    * {
      box-sizing: border-box; /* pour maîtriser width et flex-basis */
    }

    .devmind-section {
      display: block;
      margin: 0 auto;
      max-width: 1600px;
      padding: 60px 40px;
    }

    @media (max-width: 700px) {
      .devmind-section {
        padding: 25px 10px;
      }
    }

    @media (min-width: 701px) and (max-width: 900px) {
      .devmind-section {
        padding: 40px 25px;
      }
    }

    .dm-social {
      min-width: 2em;
      max-width: 2em;
      width: 2em;
      height: 2em;
    }
  </style>
  <script>
    function copyToClipboard(id) {
      const text = document.getElementById(id).innerText
        .replaceAll('~$', '')
        .replaceAll('(1)', '')
        .replaceAll('(2)', '')
        .replaceAll('(3)', '')
        .replaceAll('(4)', '')
        .replaceAll('(5)', '')
        .replaceAll('(6)', '')
        .replaceAll('(7)', '')
        .replaceAll('(8)', '')
        .replaceAll('(9)', '')
        .replaceAll('(10)', '')
      ;
      navigator.clipboard.writeText(text.substring(0, text.length));
    }
  </script>
<style>code[class*=language-]{color:#555;background:none;text-shadow:0 1px white;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.imageblock{text-align:center}.toc{background:#f0f8ff;padding:1em}h1,h2{font-weight:100}h1{font-size:35px;line-height:38px}.dm-block--blog{width:100%;background-color:#eceff1;color:#424242;padding:0;margin:0}.dm-block--blog a,.dm-block--blog a:hover,.dm-block--blog a:visited{font-weight:700;color:#424242;text-decoration:none;cursor:pointer}.dm-block--blog a:hover{color:#424242;text-decoration:underline}.dm-block--blog .link{display:block}.btn-copy-code{background-color:#fff;border:2px solid white;border-radius:24px;color:#424242!important;margin:1em .5em auto auto;font-weight:700;font-size:16px;display:block;cursor:pointer;width:auto;text-align:center;box-shadow:0 4px 5px #00000024,0 1px 10px #0000001f,0 2px 4px -1px #0003;padding:4px;font-size:small}.btn-copy-code:hover{background-color:#424242;border:2px solid #424242;color:#fff!important;padding:.5em 1em}.text-center{text-align:center}footer{background-color:#424242}.is-small-screen{display:none}.is-large-screen{display:inherit}@media screen and (max-width: 900px){.is-small-screen{display:inherit}.is-large-screen{display:none}}h1,h2{color:#424242;font-weight:100}h1{font-weight:bolder;font-size:35px;line-height:38px}h2{font-size:25px;line-height:28px}@media (max-width: 700px){h1{font-size:28px;line-height:30px}h2{font-size:22px;line-height:24px}}
</style><link rel="stylesheet" href="styles-2TVDB7GC.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles-2TVDB7GC.css"></noscript><style ng-app-id="ng">.dm_footer[_ngcontent-ng-c2660501952]{color:#eee;display:flex;justify-content:space-between;font-size:14px}.dm_footer[_ngcontent-ng-c2660501952]   .dm_society[_ngcontent-ng-c2660501952]{color:#fff}.dm_footer[_ngcontent-ng-c2660501952]   div[_ngcontent-ng-c2660501952]{margin-right:1em;width:100%}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__middle[_ngcontent-ng-c2660501952]{flex-grow:1}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__right[_ngcontent-ng-c2660501952]{text-align:right}.dm_footer[_ngcontent-ng-c2660501952]   .is-large-screen[_ngcontent-ng-c2660501952]{padding:.7em;margin:.7em 1em}.dm_footer[_ngcontent-ng-c2660501952]   .is-small-screen[_ngcontent-ng-c2660501952]{padding:0;margin:0 1em;font-size:12px}</style><style ng-app-id="ng">h1{margin-top:.5em}.dm-blog--info-date{font-size:smaller;color:#424242;border:1px solid #aaa;border-radius:24px;padding:.5em 1em;margin-right:.5em;display:inline}.blog-keywords{display:flex;margin-bottom:1em}.blog-keywords .dm-blog--keyword-detail{background-color:#ccc;color:#424242;padding:.5em 1em;margin-right:.5em;border-radius:24px;font-size:smaller}.toc{background-color:#ccc;margin-top:1em;border:1px solid #ccc;padding:1em;border-radius:8px}.toc #toctitle{font-weight:700;margin-bottom:.5em}img{max-width:100%;height:auto}.imageblock>.content{display:flex;justify-content:center;align-items:center}.highlight{display:block;overflow-x:auto;background:#f3f3f3;color:#444;padding:1.5em;box-shadow:0 8px 16px #00000026;border-radius:8px}code.hljs{padding:3px 5px}.hljs-comment{color:#697070}.hljs-punctuation,.hljs-tag{color:#444a}.hljs-tag .hljs-attr,.hljs-tag .hljs-name{color:#444}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#ab5656}.hljs-literal{color:#695}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta .hljs-string{color:#38a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.language-kotlin:before{display:block;float:right;content:"kotlin";font-weight:700;text-transform:uppercase}.language-typescript:before{display:block;float:right;content:"typescript";font-weight:700;text-transform:uppercase}.language-java:before{display:block;float:right;content:"java";font-weight:700;text-transform:uppercase}.language-javascript:before{display:block;float:right;content:"javascript";font-weight:700;text-transform:uppercase}.language-shell:before{display:block;float:right;content:"shell";font-weight:700;text-transform:uppercase}.language-yaml:before{display:block;float:right;content:"yaml";font-weight:700;text-transform:uppercase}.language-json:before{display:block;float:right;content:"json";font-weight:700;text-transform:uppercase}.language-xml:before{display:block;float:right;content:"xml";font-weight:700;text-transform:uppercase}.language-html:before{display:block;float:right;content:"html";font-weight:700;text-transform:uppercase}.language-css:before{display:block;float:right;content:"css";font-weight:700;text-transform:uppercase}.language-scss:before{display:block;float:right;content:"scss";font-weight:700;text-transform:uppercase}
</style></head>
<body><!--nghm-->
  <app-root _nghost-ng-c582792440 ng-version="18.0.0" ngh="2" ng-server-context="ssg"><app-header _ngcontent-ng-c582792440 _nghost-ng-c2882497807 ngh="0"><header _ngcontent-ng-c2882497807><div _ngcontent-ng-c2882497807 class="header-img"><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" href="/"><img _ngcontent-ng-c2882497807 src="img/logo/logo_long.svg" alt="Dev-Mind" title="Dev-Mind"></a></div><nav _ngcontent-ng-c2882497807><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" class="nav-home" href="/"><img _ngcontent-ng-c2882497807 src="/img/ic_home_white_24px.svg" rel="start" alt="Accueil"></a><a _ngcontent-ng-c2882497807 routerlink="/formations.html" aria-label="Formations" class="active" href="/formations.html"> Formations</a><a _ngcontent-ng-c2882497807 routerlink="/blog.html" aria-label="Blog" class href="/blog.html">Blog</a><a _ngcontent-ng-c2882497807 routerlink="/experience.html" aria-label="Experience" class href="/experience.html"> Expérience</a></nav><hr _ngcontent-ng-c2882497807></header><div _ngcontent-ng-c2882497807 class="header-space"></div></app-header><router-outlet _ngcontent-ng-c582792440></router-outlet><app-asciidoc-viewer ngh="1"><div class="dm-block--blog"><div class="devmind-section"><h1><!--ngetn--></h1><div class="blog-keywords"><div class="dm-blog--info-date">27/08/2024</div><div class="dm-blog--keyword-detail">Java</div><div class="dm-blog--keyword-detail">Spring</div><!---->&nbsp; </div><div class="preview"><div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a class="link" fragment="#_introduction">Introduction</a></li>
<li><a class="link" fragment="#_cors">CORS</a></li>
<li><a class="link" fragment="#_authentication">Authentication</a></li>
<li><a class="link" fragment="#_authorization">Authorization</a></li>
<li><a class="link" fragment="#_how_to_install">How to install ?</a></li>
<li><a class="link" fragment="#_flask_security_level_1"><img src="/img/ic_flask.svg" style="width: 1em"> : Security level 1</a></li>
<li><a class="link" fragment="#_how_it_works">How it works ?</a>
<ul class="sectlevel2">
<li><a class="link" fragment="#_web_filter">Web filter</a></li>
<li><a class="link" fragment="#_architecture">Architecture</a></li>
</ul>
</li>
<li><a class="link" fragment="#_configuration">Configuration</a></li>
<li><a class="link" fragment="#_get_the_user">Get the user</a></li>
<li><a class="link" fragment="#_check_permission">Check permission</a></li>
<li><a class="link" fragment="#_flask_personalize_your_configuration"><img src="/img/ic_flask.svg" style="width: 1em"> : Personalize your configuration</a></li>
<li><a class="link" fragment="#_unit_tests">Unit tests</a>
<ul class="sectlevel2">
<li><a class="link" fragment="#_resolve_error_401">Resolve error 401</a></li>
<li><a class="link" fragment="#_resolve_error_403">Resolve error 403</a></li>
<li><a class="link" fragment="#_on_a_web_application">On a web application</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-security/reference/index.html">Spring Security</a> provides comprehensive support for authentication, authorization, and protection against <a href="https://docs.spring.io/spring-security/reference/features/exploits/index.html">common exploits</a>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security.png" alt="spring security" width="800">
</div>
</div>
<div class="paragraph">
<p>The security is a complex subject. We retrieve this complexity in Spring Security</p>
</div>
<div class="paragraph">
<p>But Spring Security and Spring Boot come with an abstraction to make easier the integration with the main tools and concepts : SSO, OpenID, Oauth, NTLM, LDAP, Kerberos</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cors">CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Today browsers forbid a website to access to resources served by another website defined on a different domain.</p>
</div>
<div class="paragraph">
<p>If you want to call your API on <a href="http://localhost:8080" class="bare">http://localhost:8080</a> from a webapp exposed on a different port you should have this error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><span class="hljs-title class_">Access</span> to fetch at <span class="hljs-string">'http://localhost:8080/api/rooms'</span> <span class="hljs-keyword">from</span> origin <span class="hljs-string">'null'</span> has been blocked by <span class="hljs-variable constant_">CORS</span> <span class="hljs-attr">policy</span>:
<span class="hljs-title class_">No</span> <span class="hljs-string">'Access-Control-Allow-Origin'</span> header is present on the requested resource. <span class="hljs-title class_">If</span> an opaque response serves
your needs, set the request<span class="hljs-string">'s mode to '</span>no-cors<span class="hljs-string">' to fetch the resource with CORS disabled.</span></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-Origin Resource Sharing</a> is a mechanism that allows this dialog</p>
</div>
<div class="paragraph">
<p>To resolve this problem you have to manage CORS headers in the different requests. With Spring you can add annotation <code>@CrossOrigin</code> to your <code>@RestController</code> to open your API to all other apps</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747137.2202"><span class="hljs-meta">@CrossOrigin</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731601747137.2202')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>If your Vue.js app is launched on <a href="http://localhost:3010" class="bare">http://localhost:3010</a> ou can open your API only for this app</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747137.925"><span class="hljs-meta">@CrossOrigin(origins = { "http://localhost:3010" }, maxAge = 3600)</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731601747137.925')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>On a web application you can also install a proxy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication is how we verify the identity of who is trying to access a particular resource.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/authentication.png" alt="authentication" width="600">
</div>
</div>
<div class="paragraph">
<p>A common way to authenticate users is to force them to enter a username and password. If user is unknown, app will return a 401 error (Bad authentication)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authorization">Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once authentication is performed we know the identity and can perform authorization.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/authorization.png" alt="authorization" width="600">
</div>
</div>
<div class="paragraph">
<p>If user has no access to a resource, he will receive a 403 error (Forbidden)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_install">How to install ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use the Spring Boot starters (one for the main libs and one for tests)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747138.906">implementation(<span class="hljs-string">"org.springframework.boot:spring-boot-starter-security"</span>)
testImplementation(<span class="hljs-string">"org.springframework.security:spring-security-test"</span>)</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747138.906')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>With nothing else, Spring Security will add a basic auth to your application and you can configure the default user in <code>application.properties</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.security.user.name=user
spring.security.user.password=password</pre>
</div>
</div>
<div class="paragraph">
<p>Spring generate this page for you</p>
</div>
<div class="paragraph text-center">
<p><span class="image"><img src="../../img/training/spring-security/authent_screen.png" alt="authent screen" width="600"></span></p>
</div>
<div class="paragraph">
<p>You can logout when you try to call
<a href="http://localhost:8080/logout" class="bare">http://localhost:8080/logout</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_security_level_1"><img src="/img/ic_flask.svg" style="width: 1em"> : Security level 1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Update your project to be able to secure you app with the default security form (follow the given steps above)</p>
</div>
<div class="paragraph">
<p>At this step you can connect to your app but several things must be set to continue to use Swagger and run your controller tests. We will fix these problems in the next lab.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_it_works">How it works ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On a Spring web application, Spring Security support is based on Servlet Filters, so it is helpful to look at the role of Filters generally first.</p>
</div>
<div class="sect2">
<h3 id="_web_filter">Web filter</h3>
<div class="paragraph">
<p>When a request is sent to call a controller, the HTTP request is sent to a chain of filters. Activated filters and servlets depend on the path of the request URI.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/filter.png" alt="filter" width="800">
</div>
</div>
<div class="paragraph">
<p>In a Spring MVC application you have only one Servlet. This Servlet is an instance of DispatcherServlet. The servlet can handle a single HttpServletRequest and HttpServletResponse.</p>
</div>
<div class="paragraph">
<p>Filters can read the request and stop the filter chain if we have a problem and the filter can also update the response</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747138.5254"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(
        ServletRequest request,
        ServletResponse response,
        FilterChain chain)</span> {
	  <span class="hljs-comment">// do something before the rest of the application</span>
    chain.doFilter(request, response); <span class="hljs-comment">// invoke the rest of the application</span>
    <span class="hljs-comment">// do something after the rest of the application</span>
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747138.5254')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Filters can be activated only on a given path URI and you can add different filter chain depending on this path</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/filter2.png" alt="filter2" width="800">
</div>
</div>
<div class="paragraph">
<p>Spring Security add several filters. And Spring filter will throw an exception if user is not authenticated or if he has no right to access to a resource</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/filter3.png" alt="filter3" width="800">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_architecture">Architecture</h3>
<div class="paragraph">
<p>The security context is hold by a SecurityContextHolder. This object uses a ThreadLocal to store its data (one value by user thread)</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/architecture.png" alt="architecture" width="500">
</div>
</div>
<div class="paragraph">
<p><code>SecurityContext</code> contains an <code>Authentication</code> object.</p>
</div>
<div class="paragraph">
<p>An <code>Authentication</code> represents the currently authenticated user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>principal</code> contains the details (often an instance of UserDetails)</p>
</li>
<li>
<p><code>credentials</code> contains the password or the token</p>
</li>
<li>
<p><code>authorities</code> contains the user permissions. These permissions are usually loaded by a <code>UserDetailsService</code> class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An <code>Authentication</code> request is processed by an <code>AuthenticationProvider</code>. You can have different  providers in you app. For example,</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/spring-security/architecture2.png" alt="architecture2" width="700">
</div>
</div>
<div class="paragraph">
<p><code>DaoAuthenticationProvider</code> supports username/password based authentication while <code>JwtAuthenticationProvider</code> supports authenticating a JWT token.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can configure our own <code>UserDetailsService</code> to manage the user and their permissions. In this basic example we will use a in memory configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747139.9778"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringSecurityConfig</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROLE_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"USER"</span>;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// We create a password encoder</span>
        <span class="hljs-type">PasswordEncoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();
        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();
        manager.createUser(
                User.withUsername(<span class="hljs-string">"user"</span>).password(encoder.encode(<span class="hljs-string">"myPassword"</span>)).roles(ROLE_USER).build()
        );
        <span class="hljs-keyword">return</span> manager;
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747139.9778')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>You can add a <code>SecurityFilterChain</code> to secure an http route. The default configuration in Spring Boot is this one</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747139.1453"><span class="hljs-meta">@Bean</span>
<span class="hljs-meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span>
SecurityFilterChain <span class="hljs-title function_">defaultSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
			http.authorizeHttpRequests((requests) <span class="hljs-meta">-&gt;</span> requests.anyRequest().authenticated());
			http.formLogin(withDefaults());
			http.httpBasic(withDefaults());
			<span class="hljs-keyword">return</span> http.build();
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747139.1453')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>(1) Ensures that any request to our application requires the user to be authenticated</p>
</li>
<li>
<p>(2) Allows users to authenticate with form based login</p>
</li>
<li>
<p>(3) Allows users to authenticate with HTTP Basic authentication</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>But you can use several <code>SecurityFilterChain</code> to implement different security level. You can add another filter to only let admin user access to the route <code>/api/**</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747140.6914"><span class="hljs-meta">@Bean</span>
<span class="hljs-meta">@Order(1)</span>
<span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-keyword">return</span> http
            .authorizeHttpRequests((requests) <span class="hljs-meta">-&gt;</span> requests
                    .requestMatchers(AntPathRequestMatcher.antMatcher(<span class="hljs-string">"/api/**"</span>)).hasRole(ROLE_USER) <span class="hljs-comment">// (2)</span>
                    .anyRequest().permitAll() <span class="hljs-comment">// (3)</span>
            )
            .formLogin(withDefaults())
            .httpBasic(withDefaults())
            .build();
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747140.6914')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>(1) If you have more than one filter you need to use an annotation <code>Order</code> to define the first one to use</p>
</li>
<li>
<p>(2) requestMatchers states that this HttpSecurity will only be applicable to URLs that start with <code>/api/</code>. And for each URL we want an authenticated user with the User role</p>
</li>
<li>
<p>(3) we permit all other requests</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_get_the_user">Get the user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest way to retrieve the currently authenticated principal is via a static call to the SecurityContextHolder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747140.632"><span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();
<span class="hljs-type">String</span> <span class="hljs-variable">currentPrincipalName</span> <span class="hljs-operator">=</span> authentication.getName();</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747140.632')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, we can also inject the user via the AuthenticationPrincipal annotation in a web controller.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747141.4604"><span class="hljs-meta">@CrossOrigin</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/admin/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityController</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">User</span><span class="hljs-params">(String username)</span> {
    }

    <span class="hljs-meta">@GetMapping(path = "/me")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUserName</span><span class="hljs-params">(<span class="hljs-meta">@AuthenticationPrincipal</span> UserDetails userDetails)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(userDetails.getUsername());
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747141.4604')">Copy</button></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_check_permission">Check permission</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure your app to secure yours methods. For that, add an annotation <code>PreAuthorize</code> where you need to check a user role</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747142.173"><span class="hljs-meta">@PreAuthorize("hasRole('ADMIN')")</span> <span class="hljs-comment">// 1</span>
<span class="hljs-meta">@GetMapping(path = "/me")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUserName</span><span class="hljs-params">(<span class="hljs-meta">@AuthenticationPrincipal</span> UserDetails userDetails)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(userDetails.getUsername());
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747142.173')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>(1) Here we add a constraint on the user role and user must have the role ADMIN</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_personalize_your_configuration"><img src="/img/ic_flask.svg" style="width: 1em"> : Personalize your configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Implement a custom config to manage your users in your own <code>UserDetailsService</code>. You must have one classical user and one admin user</p>
</li>
<li>
<p>Configure security to secure all the routes exposed with /api. The user must have the role User or Admin to access to our api.</p>
</li>
<li>
<p>Add a new REST endpoint to return the username. This endpoint must be only accessible to an admin user</p>
</li>
<li>
<p>the H2 console must be also secured and only admins can manage the database via this console</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unit_tests">Unit tests</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resolve_error_401">Resolve error 401</h3>
<div class="paragraph">
<p>With Spring Security configuration you have to update your controller tests. You have to simulate a user to not receive a 401 or 403 HTTP error.</p>
</div>
<div class="paragraph">
<p>To simulate a user you can use a Spring Security test annotation called <code>@WithMockUser</code></p>
</div>
<div class="paragraph">
<p>For example in the following test, you can use this annotation to define a user with a given name or roles</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747142.322"><span class="hljs-meta">@Test</span>
<span class="hljs-meta">@WithMockUser(username = "admin", roles = "ADMIN")</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldLoadAWindowAndReturnNullIfNotFound</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    given(windowDao.findById(<span class="hljs-number">999L</span>)).willReturn(Optional.empty());
        mockMvc.perform(get(<span class="hljs-string">"/api/windows/999"</span>).accept(APPLICATION_JSON))
                <span class="hljs-comment">// check the HTTP response</span>
                .andExpect(status().isOk())
                <span class="hljs-comment">// the content can be tested with Json path</span>
                .andExpect(content().string(<span class="hljs-string">""</span>));
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747142.322')">Copy</button></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resolve_error_403">Resolve error 403</h3>
<div class="paragraph">
<p>For put, post or delete HTTP methods, Spring Security add a security level and force you to send a CSRF token. You can read more information on the <a href="https://docs.spring.io/spring-security/reference/features/exploits/csrf.html">Spring website</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_a_web_application">On a web application</h3>
<div class="paragraph">
<p>If you use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>, you can update the headers sent in a request. For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" id="1731601747143.2708"><span class="hljs-keyword">const</span> headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>();
headers.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'Basic '</span> + <span class="hljs-title function_">btoa</span>(username + <span class="hljs-string">":"</span> + password));
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'myurl'</span>, {headers});</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747143.2708')">Copy</button></pre>
</div>
</div>
<div class="sect3">
<h4 id="_in_the_tests">In the tests</h4>
<div class="paragraph">
<p>In your test you can configure csrf like on the code below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" id="1731601747144.6724"><span class="hljs-meta">@Test</span>
<span class="hljs-meta">@WithMockUser(username = "admin", roles = "ADMIN")</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldSwitchWindow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Window</span> <span class="hljs-variable">expectedWindow</span> <span class="hljs-operator">=</span> createWindow(<span class="hljs-string">"window 1"</span>);
    Assertions.assertThat(expectedWindow.getWindowStatus()).isEqualTo(WindowStatus.OPEN);

    given(windowDao.findById(<span class="hljs-number">999L</span>)).willReturn(Optional.of(expectedWindow));

    mockMvc.perform(put(<span class="hljs-string">"/api/windows/999/switch"</span>).accept(APPLICATION_JSON).with(csrf()))
            <span class="hljs-comment">// check the HTTP response</span>
            .andExpect(status().isOk())
            .andExpect(jsonPath(<span class="hljs-string">"$.name"</span>).value(<span class="hljs-string">"window 1"</span>))
            .andExpect(jsonPath(<span class="hljs-string">"$.windowStatus"</span>).value(<span class="hljs-string">"CLOSED"</span>));
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731601747144.6724')">Copy</button></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_in_the_api">In the API</h4>
<div class="paragraph">
<p>You can also disable csrf on your global configuration to be able to use your REST API. To do that add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight">http
    .<span class="hljs-title function_">csrf</span>(<span class="hljs-title class_">AbstractHttpConfigurer</span>::disable)
    .<span class="hljs-title function_">headers</span>(headers <span class="hljs-title class_">-&gt;</span> headers.<span class="hljs-title function_">frameOptions</span>(<span class="hljs-title class_">HeadersConfigurer</span>.<span class="hljs-property">FrameOptionsConfig</span>::disable));</pre>
</div>
</div>
<div class="paragraph">
<p>in your <code>SpringSecurityConfig</code> when you configure the <code>SecurityFilterChain</code> bean</p>
</div>
</div>
<div class="sect3">
<h4 id="_connect_your_own_login_page">Connect your own login page</h4>
<div class="paragraph">
<p>If nous need to use your own login page, you can configure Spring Security to use it.</p>
</div>
<div class="paragraph">
<p>You can read this <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/form.html">documentation</a></p>
</div>
</div>
</div>
</div>
</div></div></div></div></app-asciidoc-viewer><!----><app-footer _ngcontent-ng-c582792440 _nghost-ng-c2660501952 ngh="0"><footer _ngcontent-ng-c2660501952><div _ngcontent-ng-c2660501952 class="dm_footer"><div _ngcontent-ng-c2660501952 class="is-small-screen"><p _ngcontent-ng-c2660501952 id="footer-dm_society"> SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i><br _ngcontent-ng-c2660501952> SIREN : 808 720 759, au RCS de Saint-Etienne<br _ngcontent-ng-c2660501952> All right reserved - ©2024 Guillaume EHRET </p></div><div _ngcontent-ng-c2660501952 class="is-large-screen"><div _ngcontent-ng-c2660501952 class="dm_footer__middle"><div _ngcontent-ng-c2660501952 class="dm_society"> Dev-Mind </div><div _ngcontent-ng-c2660501952>SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i></div><div _ngcontent-ng-c2660501952>SIREN : 808 720 759, au RCS de Saint-Etienne</div><div _ngcontent-ng-c2660501952><small _ngcontent-ng-c2660501952>Mise à jour le 14/11/2024</small></div></div><div _ngcontent-ng-c2660501952 class="dm_footer__right"> All right reserved - ©2024 Guillaume EHRET </div></div></div></footer></app-footer></app-root>

<script src="polyfills-A7MJM4D4.js" type="module"></script><script src="main-ZP2R6S5W.js" type="module"></script>

<script id="ng-state" type="application/json">{"__nghData__":[{},{"t":{"7":"t0"},"c":{"7":[{"i":"t0","r":1,"x":2}]}},{"c":{"1":[{"i":"c490234363","r":1}]}}]}</script></body></html>