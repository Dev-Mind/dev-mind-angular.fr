<!DOCTYPE html><html lang="en" data-critters-container><head>
  <meta charset="utf-8">
  <title>Training</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      min-height: 100vh;
      max-height: 100vh;
      font-family: "Helvetica", "Arial", "sans-serif";
      padding: 0;
      margin: 0;
    }

    header {
      height: 90px;
      max-height: 90px;
      box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      background-color: white;
      display: -webkit-flex;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 99;
      transition-duration: 0.2s;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-property: max-height, box-shadow;
      position: fixed;
      width: 100%;
      text-align: center;
    }
    header hr {
      width:100%;
      background-color: #424242;
      border-color: #424242;
      display: block;
      border: 0;
      height: 0.5em;
      margin: 0;
    }
    .header-img {
      margin: auto;
      width: 50%;
      padding-top: 0.5em;
      height: 30px;
    }
    .header-img img {
      max-height: 30px !important;
    }
    .header-space {
      min-height: 90px;
    }


    @media screen and (min-width: 901px) {
      header {
        height: 120px;
        max-height: 120px;
      }
      .header-img {
        height: 60px;
      }
      .header-img img {
        max-height: 60px !important;
      }
      .header-space {
        min-height: 120px;
      }
      nav a {
        padding: 6px 24px;
      }
      .nav-home{
        display: block !important;
      }
    }


    nav {
      display: -webkit-flex;
      display: flex;
      margin: auto;
    }

    nav a {
      padding: 0 12px;
      line-height: 28px;
      height: 28px;
      color: #424242;
      margin: auto;
      text-decoration: none;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 13px;
      border-radius: 4px;
    }
    .nav-home{
      display: none;
    }
    nav a > img {
    // height: 20px;
    }

    nav a:hover {
      background-color: #9e9e9e;
    }

    nav .active {
      background-color: rgba(0, 0, 0, 0.14);
    }

    main {
      overflow-x: hidden;
    }

    img, picture {
      max-width: 100%;
      height: auto;
      margin: auto;
    }

    * {
      box-sizing: border-box; /* pour maîtriser width et flex-basis */
    }

    .devmind-section {
      display: block;
      margin: 0 auto;
      max-width: 1600px;
      padding: 60px 40px;
    }

    @media (max-width: 700px) {
      .devmind-section {
        padding: 25px 10px;
      }
    }

    @media (min-width: 701px) and (max-width: 900px) {
      .devmind-section {
        padding: 40px 25px;
      }
    }

    .dm-social {
      min-width: 2em;
      max-width: 2em;
      width: 2em;
      height: 2em;
    }
  </style>
  <script>
    function copyToClipboard(id) {
      const text = document.getElementById(id).innerText
        .replaceAll('~$', '')
        .replaceAll('(1)', '')
        .replaceAll('(2)', '')
        .replaceAll('(3)', '')
        .replaceAll('(4)', '')
        .replaceAll('(5)', '')
        .replaceAll('(6)', '')
        .replaceAll('(7)', '')
        .replaceAll('(8)', '')
        .replaceAll('(9)', '')
        .replaceAll('(10)', '')
      ;
      navigator.clipboard.writeText(text.substring(0, text.length));
    }
  </script>
<style>code[class*=language-]{color:#555;background:none;text-shadow:0 1px white;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.imageblock{text-align:center}.toc{background:#f0f8ff;padding:1em}h1,h2{font-weight:100}h1{font-size:35px;line-height:38px}.dm-block--blog{width:100%;background-color:#eceff1;color:#424242;padding:0;margin:0}.dm-block--blog a,.dm-block--blog a:hover,.dm-block--blog a:visited{font-weight:700;color:#424242;text-decoration:none;cursor:pointer}.dm-block--blog a:hover{color:#424242;text-decoration:underline}.dm-block--blog .link{display:block}.btn-copy-code{background-color:#fff;border:2px solid white;border-radius:24px;color:#424242!important;margin:1em .5em auto auto;font-weight:700;font-size:16px;display:block;cursor:pointer;width:auto;text-align:center;box-shadow:0 4px 5px #00000024,0 1px 10px #0000001f,0 2px 4px -1px #0003;padding:4px;font-size:small}.btn-copy-code:hover{background-color:#424242;border:2px solid #424242;color:#fff!important;padding:.5em 1em}.text-center{text-align:center}footer{background-color:#424242}.is-small-screen{display:none}.is-large-screen{display:inherit}@media screen and (max-width: 900px){.is-small-screen{display:inherit}.is-large-screen{display:none}}h1,h2{color:#424242;font-weight:100}h1{font-weight:bolder;font-size:35px;line-height:38px}h2{font-size:25px;line-height:28px}@media (max-width: 700px){h1{font-size:28px;line-height:30px}h2{font-size:22px;line-height:24px}}
</style><link rel="stylesheet" href="styles-2TVDB7GC.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles-2TVDB7GC.css"></noscript><style ng-app-id="ng">.dm_footer[_ngcontent-ng-c2660501952]{color:#eee;display:flex;justify-content:space-between;font-size:14px}.dm_footer[_ngcontent-ng-c2660501952]   .dm_society[_ngcontent-ng-c2660501952]{color:#fff}.dm_footer[_ngcontent-ng-c2660501952]   div[_ngcontent-ng-c2660501952]{margin-right:1em;width:100%}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__middle[_ngcontent-ng-c2660501952]{flex-grow:1}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__right[_ngcontent-ng-c2660501952]{text-align:right}.dm_footer[_ngcontent-ng-c2660501952]   .is-large-screen[_ngcontent-ng-c2660501952]{padding:.7em;margin:.7em 1em}.dm_footer[_ngcontent-ng-c2660501952]   .is-small-screen[_ngcontent-ng-c2660501952]{padding:0;margin:0 1em;font-size:12px}</style><style ng-app-id="ng">h1{margin-top:.5em}.dm-blog--info-date{font-size:smaller;color:#424242;border:1px solid #aaa;border-radius:24px;padding:.5em 1em;margin-right:.5em;display:inline}.blog-keywords{display:flex;margin-bottom:1em}.blog-keywords .dm-blog--keyword-detail{background-color:#ccc;color:#424242;padding:.5em 1em;margin-right:.5em;border-radius:24px;font-size:smaller}.toc{background-color:#ccc;margin-top:1em;border:1px solid #ccc;padding:1em;border-radius:8px}.toc #toctitle{font-weight:700;margin-bottom:.5em}img{max-width:100%;height:auto}.imageblock>.content{display:flex;justify-content:center;align-items:center}.highlight{display:block;overflow-x:auto;background:#f3f3f3;color:#444;padding:1.5em;box-shadow:0 8px 16px #00000026;border-radius:8px}code.hljs{padding:3px 5px}.hljs-comment{color:#697070}.hljs-punctuation,.hljs-tag{color:#444a}.hljs-tag .hljs-attr,.hljs-tag .hljs-name{color:#444}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#ab5656}.hljs-literal{color:#695}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta .hljs-string{color:#38a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.language-kotlin:before{display:block;float:right;content:"kotlin";font-weight:700;text-transform:uppercase}.language-typescript:before{display:block;float:right;content:"typescript";font-weight:700;text-transform:uppercase}.language-java:before{display:block;float:right;content:"java";font-weight:700;text-transform:uppercase}.language-javascript:before{display:block;float:right;content:"javascript";font-weight:700;text-transform:uppercase}.language-shell:before{display:block;float:right;content:"shell";font-weight:700;text-transform:uppercase}.language-yaml:before{display:block;float:right;content:"yaml";font-weight:700;text-transform:uppercase}.language-json:before{display:block;float:right;content:"json";font-weight:700;text-transform:uppercase}.language-xml:before{display:block;float:right;content:"xml";font-weight:700;text-transform:uppercase}.language-html:before{display:block;float:right;content:"html";font-weight:700;text-transform:uppercase}.language-css:before{display:block;float:right;content:"css";font-weight:700;text-transform:uppercase}.language-scss:before{display:block;float:right;content:"scss";font-weight:700;text-transform:uppercase}
</style></head>
<body><!--nghm-->
  <app-root _nghost-ng-c582792440 ng-version="18.0.0" ngh="2" ng-server-context="ssg"><app-header _ngcontent-ng-c582792440 _nghost-ng-c2882497807 ngh="0"><header _ngcontent-ng-c2882497807><div _ngcontent-ng-c2882497807 class="header-img"><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" href="/"><img _ngcontent-ng-c2882497807 src="img/logo/logo_long.svg" alt="Dev-Mind" title="Dev-Mind"></a></div><nav _ngcontent-ng-c2882497807><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" class="nav-home" href="/"><img _ngcontent-ng-c2882497807 src="/img/ic_home_white_24px.svg" rel="start" alt="Accueil"></a><a _ngcontent-ng-c2882497807 routerlink="/formations.html" aria-label="Formations" class="active" href="/formations.html"> Formations</a><a _ngcontent-ng-c2882497807 routerlink="/blog.html" aria-label="Blog" class href="/blog.html">Blog</a><a _ngcontent-ng-c2882497807 routerlink="/experience.html" aria-label="Experience" class href="/experience.html"> Expérience</a></nav><hr _ngcontent-ng-c2882497807></header><div _ngcontent-ng-c2882497807 class="header-space"></div></app-header><router-outlet _ngcontent-ng-c582792440></router-outlet><app-asciidoc-viewer ngh="1"><div class="dm-block--blog"><div class="devmind-section"><h1><!--ngetn--></h1><div class="blog-keywords"><div class="dm-blog--info-date">15/08/2024</div><div class="dm-blog--keyword-detail">Android</div><!---->&nbsp; </div><div class="preview"><div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a class="link" fragment="#_explore_api">Explore API</a></li>
<li><a class="link" fragment="#_retrofit">Retrofit</a></li>
<li><a class="link" fragment="#_flask_configure_retrofit"><img src="/img/ic_flask.svg" style="width: 1em"> : Configure Retrofit</a></li>
<li><a class="link" fragment="#_flask_use_retrofit"><img src="/img/ic_flask.svg" style="width: 1em"> : Use Retrofit</a></li>
<li><a class="link" fragment="#_main_thread">Main thread</a></li>
<li><a class="link" fragment="#_coroutines">Coroutines</a></li>
<li><a class="link" fragment="#_flask_use_coroutines_to_resolve_main_thread_error"><img src="/img/ic_flask.svg" style="width: 1em"> : Use coroutines to resolve main thread error</a></li>
<li><a class="link" fragment="#_android_permission">Android permission</a></li>
<li><a class="link" fragment="#_use_viewmodel_in_your_code">Use ViewModel in your code</a></li>
<li><a class="link" fragment="#_flask_update_the_screen_to_display_and_update_the_detail"><img src="/img/ic_flask.svg" style="width: 1em"> : Update the screen to display and update the detail</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this lesson, we will see how to call a remote HTTP API with an external library called <a href="https://square.github.io/retrofit/">Retrofit</a>. <a href="https://square.github.io/retrofit/">Retrofit</a> was not done by Google. But when a library created by the community is widely used, well designed, the Android team does not hesitate to encourage its use.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../img/training/android/android-call-remote.png" alt="Call an HTTP API with Android" width="800">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_explore_api">Explore API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you followed the previous code labs to build a Spring application, you will be able to use your own app. You should have an API to list building rooms and other to load detailed information on a room.</p>
</div>
<div class="paragraph">
<p>For the moment data are static in <code>com.automacorp.model.RoomService</code>. Now we will update this service to read data stored on a web server, as a REST web service.</p>
</div>
<div class="paragraph">
<p>You can use your own Spring API if you followed Spring course or my implementation available on <a href="https://automacorp.devmind.cleverapps.io/swagger-ui/index.html" class="bare">https://automacorp.devmind.cleverapps.io/swagger-ui/index.html</a>. This app is secured by basic auth and you can the username <code>user</code> and his password <code>password</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_retrofit">Retrofit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To interact with a remote HTTP API in Android app, your app needs to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>establish a network connection to remote server which exposes your REST service and</p>
</li>
<li>
<p>communicate with that server, and then</p>
</li>
<li>
<p>receive its response data and</p>
</li>
<li>
<p>parse the data to be usable in your code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retrofit was made to do all these steps easily. For the last one, we need a converter to deserialize HTTP body. Several converters are available. We will use <a href="https://github.com/square/moshi/">Moshi</a> library</p>
</div>
<div class="paragraph">
<p>The mains goal of Retrofit is to turn your HTTP API into a Java interface. For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728389.7852"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RoomsApiService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"rooms"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>: <span class="hljs-symbol">Call&lt;List&lt;RoomDto&gt;&gt;

    <span class="hljs-meta">@GET(<span class="hljs-string">"rooms/{id}"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@Path(<span class="hljs-string">"id"</span>)</span> id: <span class="hljs-type">Long</span>)</span></span>: <span class="hljs-symbol">Call&lt;RoomDto&gt;

    <span class="hljs-meta">@PUT(<span class="hljs-string">"rooms/{id}"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateRoom</span><span class="hljs-params">(<span class="hljs-meta">@Path(<span class="hljs-string">"id"</span>)</span> id: <span class="hljs-type">Long</span>, <span class="hljs-meta">@Body</span> room: <span class="hljs-type">RoomCommandDto</span>)</span></span>: <span class="hljs-symbol">Call&lt;RoomDto&gt;

    <span class="hljs-comment">//...</span>
}</span></span></span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728389.7852')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Annotations (GET, POST, PUT, DELETE,…​) on the interface methods and its parameters indicate how a request will be handled.</p>
</div>
<div class="paragraph">
<p>A request URL can be updated dynamically using replacement blocks and parameters on the method. A replacement block is an alphanumeric string surrounded by { and }.</p>
</div>
<div class="paragraph">
<p>You can bind a parameter in path</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728390.8845"><span class="hljs-meta">@GET(<span class="hljs-string">"rooms/{id}"</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@Path(<span class="hljs-string">"id"</span>)</span> id: <span class="hljs-type">Long</span>)</span></span>: <span class="hljs-symbol">Call&lt;RoomDto&gt;</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728390.8845')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>or a parameter in query</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728391.2234"><span class="hljs-meta">@GET(<span class="hljs-string">"rooms"</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findAll</span><span class="hljs-params">(<span class="hljs-meta">@Query(<span class="hljs-string">"sort"</span>)</span> sort: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-symbol">Call&lt;List&lt;RoomDto&gt;&gt;</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728391.2234')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>An object can be specified for POST or PUT HTTP requests @Body annotation. In this case, Retrofit will use converter defined in your conf to serialize body object in JSON</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728392.9832"><span class="hljs-meta">@PUT(<span class="hljs-string">"rooms/{id}"</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateRoom</span><span class="hljs-params">(<span class="hljs-meta">@Path(<span class="hljs-string">"id"</span>)</span> id: <span class="hljs-type">Long</span>, <span class="hljs-meta">@Body</span> room: <span class="hljs-type">RoomCommandDto</span>)</span></span>: <span class="hljs-symbol">Call&lt;RoomDto&gt;</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728392.9832')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>In my example RoomCommandDto is different than RoomDto. If you use my remote API available on on <a href="https://automacorp.devmind.cleverapps.io" class="bare">https://automacorp.devmind.cleverapps.io</a> you could define these objects in your code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728393.649"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomDto</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> currentTemperature: <span class="hljs-built_in">Double</span>?,
    <span class="hljs-keyword">val</span> targetTemperature: <span class="hljs-built_in">Double</span>?,
    <span class="hljs-keyword">val</span> windows: <span class="hljs-symbol">List&lt;WindowDto&gt;
)

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomCommandDto</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> currentTemperature: <span class="hljs-built_in">Double</span>?,
    <span class="hljs-keyword">val</span> targetTemperature: <span class="hljs-built_in">Double</span>?,
    <span class="hljs-keyword">val</span> floor: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>,
    <span class="hljs-comment">// Set to the default building ID (useful when you have not created screens to manage buildings)</span>
    <span class="hljs-keyword">val</span> buildingId: <span class="hljs-built_in">Long</span> = -<span class="hljs-number">10</span>
)</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728393.649')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>These 2 objects are 2 projections of a Room: one for the read, one for the update.
You will find more information on <a href="https://square.github.io/retrofit/">Retrofit</a> website</p>
</div>
<div class="paragraph">
<p>It is the time to test by yourself.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_configure_retrofit"><img src="/img/ic_flask.svg" style="width: 1em"> : Configure Retrofit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I said we need to install Retrofit to call a remote API and we also need another library to serialize/deserialize our Kotlin objects in/from JSON.</p>
</div>
<div class="paragraph">
<p>Android project use now the Gradle catalog version. Open the file <code>libs.versions.toml</code>. This file register all versions of libraries used in your project. You can add a new line to register the version of Retrofit and Moshi</p>
</div>
<div class="paragraph">
<p>Each section are defined by [] and the name of the section.</p>
</div>
<div class="paragraph">
<p>In the section <code>[versions]</code> you can add the version of Retrofit and Moshi</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-toml" id="1731613728398.0146"><span class="hljs-attr">retrofit</span> = <span class="hljs-string">"2.9.0"</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728398.0146')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>In the section <code>[libraries]</code> you can add the dependency of Retrofit and Moshi</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-toml" id="1731613728400.2222"><span class="hljs-attr">retrofit</span> = { module = <span class="hljs-string">"com.squareup.retrofit2:retrofit"</span>, version.ref = <span class="hljs-string">"retrofit"</span> }
<span class="hljs-attr">retrofit-moshi</span> = { module = <span class="hljs-string">"com.squareup.retrofit2:converter-moshi"</span>, version.ref = <span class="hljs-string">"retrofit"</span> }</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728400.2222')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Now open <strong>build.gradle.kts (Module: automacorp.app)</strong>. and add the following dependencies</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" id="1731613728404.5198">implementation (libs.retrofit)
implementation (libs.converter.moshi)</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728404.5198')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>As you updated your gradle configuration, Android Studio display a message to synchronize your projet. Click on <strong>Sync now</strong></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../img/training/android/android-gradle-sync.png" alt="Sync Gradle project"></span></p>
</div>
<div class="paragraph">
<p>Now you are ready to write the code to call your API.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In package <code>com.automacorp.service</code> create a new interface called <code>RoomsApiService</code></p>
</li>
<li>
<p>You can apply the examples given above. In this interface we declare methods used to launch a remote call to</p>
<div class="ulist">
<ul>
<li>
<p>read all rooms</p>
</li>
<li>
<p>read one room by its id</p>
</li>
<li>
<p>update a room</p>
</li>
<li>
<p>create a room</p>
</li>
<li>
<p>delete a room by its id</p>
</li>
</ul>
</div>
</li>
<li>
<p>We need to create an implementation of this interface. This implementation will be created by the Retrofit Builder. In package <code>com.automacorp.service</code> create a new class called <strong>ApiServices</strong>. This class will use a Retrofit builder to return an instance of interface <code>RoomsApiService</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728405.2058"><span class="hljs-keyword">object</span> ApiServices {
    <span class="hljs-keyword">val</span> roomsApiService : RoomsApiService <span class="hljs-keyword">by</span> lazy {
        Retrofit.Builder()
                .addConverterFactory(MoshiConverterFactory.create()) <span class="hljs-comment">// (1)</span>
                .baseUrl(<span class="hljs-string">"http://automacorp.devmind.cleverapps.io/api/"</span>) <span class="hljs-comment">// (2)</span>
                .build()
                .create(RoomsApiService::<span class="hljs-keyword">class</span>.java)
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728405.2058')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p><strong>(1)</strong> a converter factory to tell Retrofit what do with the data it gets back from the web service.</p>
</div>
<div class="paragraph">
<p><strong>(2)</strong> an URL of the remote service (In this example I use an URL on my website but you can use your own API)</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When an API is secured by a basic authentication, we need to adapt the settings. For that we can add 2 constant in object <code>ApiServices</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728406.3445"><span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> API_USERNAME = <span class="hljs-string">"user"</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> API_PASSWORD = <span class="hljs-string">"password"</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728406.3445')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>As often, when we have to manage credential in an HTTP request, we will create an interceptor to intercept the outgoing requests and add the authentication credential inside.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728407.0203"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicAuthInterceptor</span>(<span class="hljs-keyword">val</span> username: String, <span class="hljs-keyword">val</span> password: String): Interceptor {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">intercept</span><span class="hljs-params">(chain: <span class="hljs-type">Interceptor</span>.<span class="hljs-type">Chain</span>)</span></span>: Response {
        <span class="hljs-keyword">val</span> request = chain
            .request()
            .newBuilder()
            .header(<span class="hljs-string">"Authorization"</span>, Credentials.basic(username, password))
            .build()
        <span class="hljs-keyword">return</span> chain.proceed(request)
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728407.0203')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>When your interceptor is created,  you can adapt the Retrofit builder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728407.9497"><span class="hljs-keyword">val</span> roomsApiService : RoomsApiService <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">val</span> client = OkHttpClient.Builder()
            .addInterceptor(BasicAuthInterceptor(API_USERNAME, API_PASSWORD))
            .build()

    Retrofit.Builder()
        .addConverterFactory(MoshiConverterFactory.create())
        .client(client)
        .baseUrl(<span class="hljs-string">"https://automacorp.devmind.cleverapps.io/api/"</span>)
        .build()
        .create(RoomsApiService::<span class="hljs-keyword">class</span>.java)
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728407.9497')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>If your application is served over HTTPS (this is the default on Clever Cloud), you also need to customize the OkHttpClient. In the real life we use a real certificate. In our dev we just check the hostname of our remote server</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728409.9346"><span class="hljs-keyword">val</span> roomsApiService : RoomsApiService <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">val</span> client = getUnsafeOkHttpClient()
            .addInterceptor(BasicAuthInterceptor(API_USERNAME, API_PASSWORD))
            .build()

    <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUnsafeOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient.Builder =
  OkHttpClient.Builder().apply {
      <span class="hljs-keyword">val</span> trustManager = <span class="hljs-keyword">object</span> : X509TrustManager {
          <span class="hljs-meta">@Throws(CertificateException::class)</span>
          <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkClientTrusted</span><span class="hljs-params">(chain: <span class="hljs-type">Array</span><span>&lt;X509Certificate</span><span>&gt;</span>, authType: <span class="hljs-type">String</span>)</span></span> {
          }

          <span class="hljs-meta">@Throws(CertificateException::class)</span>
          <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkServerTrusted</span><span class="hljs-params">(chain: <span class="hljs-type">Array</span><span>&lt;X509Certificate</span><span>&gt;</span>, authType: <span class="hljs-type">String</span>)</span></span> {
          }

          <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAcceptedIssuers</span><span class="hljs-params">()</span></span>: <span class="hljs-symbol">Array&lt;X509Certificate&gt; {
              <span class="hljs-keyword">return</span> arrayOf()
          }
      }
      <span class="hljs-keyword">val</span> sslContext = SSLContext.getInstance(<span class="hljs-string">"SSL"</span>).also {
          it.<span class="hljs-keyword">init</span>(<span class="hljs-literal">null</span>, arrayOf(trustManager), SecureRandom())
      }
      sslSocketFactory(sslContext.socketFactory, trustManager)
      hostnameVerifier { hostname, _ <span class="hljs-meta">-&gt;</span> hostname.contains(<span class="hljs-string">"cleverapps.io"</span>) }
      addInterceptor(BasicAuthInterceptor(API_USERNAME, API_PASSWORD))
  }</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728409.9346')">Copy</button></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_use_retrofit"><img src="/img/ic_flask.svg" style="width: 1em"> : Use Retrofit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can now adapt our code to use this API when we want to display the room list or a room detail. For the moment, the list of rooms is populated with this code <code>roomsAdapter.setItems(WindowService.ROOMS)</code> in your <code>RoomListActivity</code>.</p>
</div>
<div class="paragraph">
<p>We can replace this line by this code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728411.247"> runCatching {  <span class="hljs-comment">// (1)</span>
   ApiServices.roomsApiService.findAll().execute()  <span class="hljs-comment">// (2)</span>
 }
      .onSuccess { <span class="hljs-comment">// (3)</span>
          <span class="hljs-keyword">val</span> rooms = it.body() ?: emptyList()
          LazyColumn(
              state = state,
              contentPadding = PaddingValues(<span class="hljs-number">4.</span>dp),
              verticalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp),
              modifier = Modifier.padding(innerPadding),

              ) {
              items(rooms, key = { it.id }) {
                  RoomItem(
                      room = it,
                      modifier = Modifier.clickable { openRoom(it.id) },
                  )
              }
          }
      }
      .onFailure {
          it.printStackTrace() <span class="hljs-comment">// (4)</span>
          Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"Error on rooms loading $it"</span>, Toast.LENGTH_LONG).show() <span class="hljs-comment">// (5)</span>
      }</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728411.247')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>(1)</strong> we use <strong>runCatching</strong> to manage successes and failures. This block is like a try/catch block in Java</p>
</li>
<li>
<p><strong>(2)</strong> <code>ApiServices.roomsApiService</code> return an implementation of our object written to call a remote API. We call the method <strong>execute</strong> to run a synchronous call</p>
</li>
<li>
<p><strong>(3)</strong> On success we update adapter with the result contained in body property. If this response is null the list is empty.</p>
</li>
<li>
<p><strong>(4)</strong> We use this line to have the real stack trace in your device log file</p>
</li>
<li>
<p><strong>(5)</strong> on error we display a message in a <a href="https://developer.android.com/guide/topics/ui/notifiers/toasts">Toast notation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Run your app to see the changes when and open the room list.</p>
</div>
<div class="paragraph">
<p>Unfortunately you should have a toast notification with the following error message :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/android-main-thread.png" alt="Network error">
</div>
</div>
<div class="paragraph">
<p>To analyse the errors you can open the LogCat tab and filter on Error level. In my example below, we can see the same error</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/remote/android-logcat.png" alt="Logger">
</div>
</div>
<div class="paragraph">
<p>To resolve the problem we have to understand the next chapters</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_main_thread">Main thread</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the system launches your application, that application runs in a thread called <strong>Main thread</strong>. This main thread manages user interface operations (rendering, events …​), system calls…​</p>
</div>
<div class="paragraph">
<p>Calling long-running operations from this main thread can lead to freezes and unresponsiveness.</p>
</div>
<div class="paragraph">
<p>Making a network request on the main thread forces it to wait, or block, until it receives a response.</p>
</div>
<div class="paragraph">
<p>When the thread is blocked, the OS isn’t able to manage UI events, which causes your app to freeze and potentially leads to an Application Not Responding (ANR) dialog. To avoid these performance issues, Android throws a <strong>MainThreadException</strong> and kills your app if you try to block this main thread.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/remote/android-main-thread-error.png" alt="Main thread">
</div>
</div>
<div class="paragraph">
<p>The solution is to run your network call, your long-running task in another thread, and when the result is available you can reattach the main thread to display the result. Only the main thread can update the interface.</p>
</div>
<div class="paragraph">
<p>If you develop in Java, Thread development can be difficult. With Kotlin and <a href="https://kotlinlang.org/docs/coroutines-guide.html">coroutines</a>, the development is really simple.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coroutines">Coroutines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <a href="https://kotlinlang.org/docs/coroutines-guide.html">coroutine</a> is a concurrency design pattern that you can use on Android to simplify code that executes asynchronously tasks as an HTTP request. Coroutines help to manage long-running tasks that might otherwise block the main thread and cause your app to become unresponsive.</p>
</div>
<div class="paragraph">
<p>In Kotlin, all coroutines run inside a <a href="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/">CoroutineScope</a>. A scope controls the lifetime of coroutines through its job. When you cancel the job of a scope, it cancels all coroutines started in that scope.</p>
</div>
<div class="paragraph">
<p>On Android, you can use a scope to cancel all running coroutines when, for example, the user navigates away from an Activity or Fragment. Scopes also allow you to specify a default dispatcher. A dispatcher controls which thread runs a coroutine.</p>
</div>
<div class="paragraph">
<p>Each object in Android which has a <a href="https://developer.android.com/topic/libraries/architecture/lifecycle">lifecycle</a> (Activity, Fragment…​), has a <code>CoroutineScope</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_use_coroutines_to_resolve_main_thread_error"><img src="/img/ic_flask.svg" style="width: 1em"> : Use coroutines to resolve main thread error</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to add the coroutine library in your project. The dependency should be already present</p>
</div>
<div class="paragraph">
<p>Open <strong>build.gradle.kts (Module: automacorp.app)</strong> to check the presence of the following dependency (in dependencies block)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728412.9717">implementation(libs.androidx.lifecycle.runtime.ktx)</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728412.9717')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Android Studio display a message to synchronize your projet. Click on <strong>Sync now</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/android-gradle-sync.png" alt="Sync Gradle project">
</div>
</div>
<div class="paragraph">
<p>We can now adapt the code used in <code>RoomListActivity</code> to load the room list.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <strong>com.automacorp.RoomListActivity</strong></p>
</li>
<li>
<p>Update code to call roomsApiService as follows</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728412.2283">lifecycleScope.launch(context = Dispatchers.IO) { <span class="hljs-comment">// (1)</span>
    runCatching { ApiServices.roomsApiService.findAll().execute() }
        .onSuccess {
            <span class="hljs-keyword">val</span> rooms = it.body() ?: emptyList()
            withContext(context = Dispatchers.Main) { <span class="hljs-comment">// (2)</span>
                <span class="hljs-comment">// setContent ....</span>
            }
        .onFailure {
            withContext(context = Dispatchers.Main) {
                it.printStackTrace()
                Toast.makeText(applicationContext, <span class="hljs-string">"Error on rooms loading $it"</span>, Toast.LENGTH_LONG)
                    .show()  <span class="hljs-comment">// (3)</span>
            }
        }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728412.2283')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>(1)</strong> method <code>lifecycleScope.launch</code> open a new coroutine. You must specify a context other than Dispatchers. <code>Main</code> (Main thread) for the code to be executed. <code>Dispatchers.IO</code> is dedicated to Input/Output tasks</p>
</li>
<li>
<p><strong>(2)</strong> You cant' interact with the view outside the main thread. When we receive the data we use <code>withContext</code> to reattach your code to another thread</p>
</li>
<li>
<p><strong>(3)</strong> Display</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Relaunch your app to test your Room list screen.</p>
</div>
<div class="paragraph">
<p>Unfortunately you should have another toast notification with another error message. The error message tells you that your app might be missing the INTERNET permission.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/remote/android-permission-error.png" alt="Android permission error">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_android_permission">Android permission</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of a permission is to protect the privacy of an Android user. Android apps must request permission to access sensitive user data or features such as contacts, SMS, Internet…​ Depending on the feature, the system might grant the permission automatically or might prompt the user to approve the request.</p>
</div>
<div class="paragraph">
<p>By default, an app has no permission to perform any operations that would adversely impact other apps, the operating system or the user.</p>
</div>
<div class="paragraph">
<p>To add a new permission we need to update the <code>AndroidManifest.xml</code> file (ie the id card of your app)</p>
</div>
<div class="paragraph">
<p>In the following example I add the INTERNET permission <code>&lt;uses-permission&gt;</code> tag (just before &lt;application&gt; tag)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" id="1731613728413.1545">&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
package="com.example.snazzyapp"&gt;

    &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
    &lt;application ...
         android:usesCleartextTraffic="true"&gt;
        ...
    &lt;/application&gt;
&lt;/manifest&gt;</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728413.1545')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Each user can accept or reject an app permission request, when this app is installed or when the user update the app settings in the device setting. So generally, you must handle this case and ask the user to reactivate the rights if he wants to use your application. In our case we will not test the authorization and we will consider that the user has accepted this permission.</p>
</div>
<div class="paragraph">
<p>You can now relaunch your app and you will be able to open the room list without error. For more information about permissions you can read this <a href="https://developer.android.com/guide/topics/permissions/overview">page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_viewmodel_in_your_code">Use ViewModel in your code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In last labs, we see how to use a <code>ViewModel</code> that can store your app data. The stored data is not lost if the framework destroys and recreates the activities during a configuration change or other events. That’s why it’s better to use a ViewModel</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/training/android/remote/view_model.png" alt="ViewModel state" width="500">
</div>
</div>
<div class="paragraph">
<p>The first thing is to create an object that will store the room list result or the error if the API call fails.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728413.8105"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomList</span>(
    <span class="hljs-keyword">val</span> rooms: <span class="hljs-symbol">List&lt;RoomDto&gt; = emptyList(),
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
)</span></code><button class="btn-copy-code" onclick="copyToClipboard('1731613728413.8105')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>We can now update the <code>RoomViewModel</code> to store the result of the API call (a state) in a <code>StateFlow</code> object. StateFlow is a data holder observable flow that emits the current and new state updates. Its value property reflects the current state value. To update state and send it to the flow, assign a new value to the value property of the MutableStateFlow class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728414.2039"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-comment">// existing code</span>

    <span class="hljs-keyword">val</span> roomsState = MutableStateFlow(RoomList())
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728414.2039')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>You can now add the function to load the room list in the <code>RoomViewModel</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728415.3093"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-comment">// existing code</span>
    <span class="hljs-comment">//...</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch(context = Dispatchers.IO) { <span class="hljs-comment">// (1)</span>
            runCatching { ApiServices.roomsApiService.findAll().execute() }
                .onSuccess {
                    <span class="hljs-keyword">val</span> rooms = it.body() ?: emptyList()
                    roomsState.value = RoomList(rooms) <span class="hljs-comment">// (2)</span>
                }
                .onFailure {
                    it.printStackTrace()
                    roomsState.value = RoomList(emptyList(), it.stackTraceToString() ) <span class="hljs-comment">// (3)</span>
                }
        }
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728415.3093')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>(1)</strong> method <code>viewModelScope.launch</code> open a new coroutine to launch the API call in another thread</p>
</li>
<li>
<p><strong>(2)</strong> Update the <code>roomsState</code> object with the result of the API call when everything is OK.</p>
</li>
<li>
<p><strong>(3)</strong> If an error occurs, we update the <code>roomsState</code> object with an empty list and the error message</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The last step is to update the <code>RoomListActivity</code> to use the <code>RoomViewModel</code> to load the room list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728418.749"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomListActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()

        <span class="hljs-keyword">val</span> viewModel: RoomViewModel <span class="hljs-keyword">by</span> viewModels()

        <span class="hljs-comment">// existing code to manage the back button and the RoomItem click to open a room detail</span>
        <span class="hljs-comment">// ...</span>

        setContent {
            AutomacorpTheme {
                Scaffold(
                    topBar = { AutomacorpTopAppBar(<span class="hljs-string">"Rooms"</span>, navigateBack) }
                ) { innerPadding <span class="hljs-meta">-&gt;</span>
                    <span class="hljs-keyword">val</span> roomsState <span class="hljs-keyword">by</span> viewModel.roomsState.asStateFlow().collectAsState() <span class="hljs-comment">// (1)</span>
                    LaunchedEffect(<span class="hljs-built_in">Unit</span>) { <span class="hljs-comment">// (2)</span>
                        viewModel.findAll()
                    }
                    <span class="hljs-keyword">if</span> (roomsState.error != <span class="hljs-literal">null</span>) {
                        Toast
                            .makeText(applicationContext, <span class="hljs-string">"Error on rooms loading ${roomsState.error}"</span>, Toast.LENGTH_LONG)
                            .show() <span class="hljs-comment">// (3)</span>
                    }
                    <span class="hljs-keyword">else</span> {
                      LazyColumn(
                          contentPadding = PaddingValues(<span class="hljs-number">4.</span>dp),
                          verticalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp),
                          modifier = Modifier.padding(innerPadding),

                          ) { <span class="hljs-comment">// (4)</span>
                          items(roomsState.rooms, key = { it.id }) {
                              RoomItem(
                                  room = it,
                                  modifier = Modifier.clickable { openRoom(it.id) },
                              )
                          }
                      }
                    }
                }
            }
        }
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728418.749')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>(1)</strong> We use the <code>asStateFlow</code> extension function to convert the <code>roomsState</code> object to a <code>StateFlow</code> object. We can now use the <code>collectAsState</code> function to observe the <code>StateFlow</code> object and update the UI when the value of the <code>StateFlow</code> object changes.</p>
</li>
<li>
<p><strong>(2)</strong> LaunchedEffect: run suspend functions (function executed in coroutine) in the scope of a composable</p>
</li>
<li>
<p><strong>(3)</strong> Display a toast notification if an error occurs</p>
</li>
<li>
<p><strong>(4)</strong> Display the list of rooms if no error occurs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With this code we have to write less code, manage less coroutine. The activity will subscribe to the <code>roomsState</code> object to display the result, and we don’t need to juggle with the main thread.</p>
</div>
<div class="paragraph">
<p>On the first display of the screen, we display an empty list of rooms because the findAll function is launched in asynchronous mode (in a coroutine). When the API call is finished, the <code>roomsState</code> object is updated with the result of the API call and the screen is updated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flask_update_the_screen_to_display_and_update_the_detail"><img src="/img/ic_flask.svg" style="width: 1em"> : Update the screen to display and update the detail</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In <code>RoomViewModel</code> we already manage the state of the room detail screen. Add a function to load a room by its id by a remote API call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728419.8093"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findRoom</span><span class="hljs-params">(id: <span class="hljs-type">Long</span>)</span></span> {
    viewModelScope.launch(context = Dispatchers.IO) {
        runCatching { ApiServices.roomsApiService.findById(id).execute() }
            .onSuccess {
                room = it.body()
            }
            .onFailure {
                it.printStackTrace()
                room = <span class="hljs-literal">null</span>
            }
    }
}</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728419.8093')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add a function to update a room by its id by a remote API call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" id="1731613728420.8303"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateRoom</span><span class="hljs-params">(id: <span class="hljs-type">Long</span>, roomDto: <span class="hljs-type">RoomDto</span>)</span></span> {
      <span class="hljs-keyword">val</span> command = RoomCommandDto(
          name = roomDto.name,
          targetTemperature = roomDto.targetTemperature ?.let { Math.round(it * <span class="hljs-number">10</span>) /<span class="hljs-number">10.0</span> },
          currentTemperature = roomDto.currentTemperature,
      )
      viewModelScope.launch(context = Dispatchers.IO) {
          runCatching { ApiServices.roomsApiService.updateRoom(id, command).execute() }
              .onSuccess {
                  room = it.body()
              }
              .onFailure {
                  it.printStackTrace()
                  room = <span class="hljs-literal">null</span>
              }
      }
  }</code><button class="btn-copy-code" onclick="copyToClipboard('1731613728420.8303')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>You can now adapt the <code>RoomActivity</code> to use the <code>RoomViewModel</code> to load the room detail and remove the local call to our fake service. After this lab you should use your remote REST Service to load and update the room detail.</p>
</div>
<div class="paragraph">
<p>Implement the different functions to create a room, delete a room, list the windows of a room, update a window.</p>
</div>
</div>
</div></div></div></div></app-asciidoc-viewer><!----><app-footer _ngcontent-ng-c582792440 _nghost-ng-c2660501952 ngh="0"><footer _ngcontent-ng-c2660501952><div _ngcontent-ng-c2660501952 class="dm_footer"><div _ngcontent-ng-c2660501952 class="is-small-screen"><p _ngcontent-ng-c2660501952 id="footer-dm_society"> SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i><br _ngcontent-ng-c2660501952> SIREN : 808 720 759, au RCS de Saint-Etienne<br _ngcontent-ng-c2660501952> All right reserved - ©2024 Guillaume EHRET </p></div><div _ngcontent-ng-c2660501952 class="is-large-screen"><div _ngcontent-ng-c2660501952 class="dm_footer__middle"><div _ngcontent-ng-c2660501952 class="dm_society"> Dev-Mind </div><div _ngcontent-ng-c2660501952>SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i></div><div _ngcontent-ng-c2660501952>SIREN : 808 720 759, au RCS de Saint-Etienne</div><div _ngcontent-ng-c2660501952><small _ngcontent-ng-c2660501952>Mise à jour le 14/11/2024</small></div></div><div _ngcontent-ng-c2660501952 class="dm_footer__right"> All right reserved - ©2024 Guillaume EHRET </div></div></div></footer></app-footer></app-root>

<script src="polyfills-A7MJM4D4.js" type="module"></script><script src="main-RCAYVOUE.js" type="module"></script>

<script id="ng-state" type="application/json">{"__nghData__":[{},{"t":{"7":"t0"},"c":{"7":[{"i":"t0","r":1}]}},{"c":{"1":[{"i":"c490234363","r":1}]}}]}</script></body></html>