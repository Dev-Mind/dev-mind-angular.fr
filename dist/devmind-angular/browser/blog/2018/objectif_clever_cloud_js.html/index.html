<!DOCTYPE html><html lang="en" data-critters-container><head>
  <meta charset="utf-8">
  <title>Blog</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      min-height: 100vh;
      max-height: 100vh;
      font-family: "Helvetica", "Arial", "sans-serif";
      padding: 0;
      margin: 0;
    }

    header {
      height: 90px;
      max-height: 90px;
      box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      background-color: white;
      display: -webkit-flex;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 99;
      transition-duration: 0.2s;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-property: max-height, box-shadow;
      position: fixed;
      width: 100%;
      text-align: center;
    }
    header hr {
      width:100%;
      background-color: #424242;
      border-color: #424242;
      display: block;
      border: 0;
      height: 0.5em;
      margin: 0;
    }
    .header-img {
      margin: auto;
      width: 50%;
      padding-top: 0.5em;
      height: 30px;
    }
    .header-img img {
      max-height: 30px !important;
    }
    .header-space {
      min-height: 90px;
    }


    @media screen and (min-width: 901px) {
      header {
        height: 120px;
        max-height: 120px;
      }
      .header-img {
        height: 60px;
      }
      .header-img img {
        max-height: 60px !important;
      }
      .header-space {
        min-height: 120px;
      }
      nav a {
        padding: 6px 24px;
      }
      .nav-home{
        display: block !important;
      }
    }


    nav {
      display: -webkit-flex;
      display: flex;
      margin: auto;
    }

    nav a {
      padding: 0 12px;
      line-height: 28px;
      height: 28px;
      color: #424242;
      margin: auto;
      text-decoration: none;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 13px;
      border-radius: 4px;
    }
    .nav-home{
      display: none;
    }
    nav a > img {
    // height: 20px;
    }

    nav a:hover {
      background-color: #9e9e9e;
    }

    nav .active {
      background-color: rgba(0, 0, 0, 0.14);
    }

    main {
      overflow-x: hidden;
    }

    img, picture {
      max-width: 100%;
      height: auto;
      margin: auto;
    }

    * {
      box-sizing: border-box; /* pour maîtriser width et flex-basis */
    }

    .devmind-section {
      display: block;
      margin: 0 auto;
      max-width: 1600px;
      padding: 60px 40px;
    }

    @media (max-width: 700px) {
      .devmind-section {
        padding: 25px 10px;
      }
    }

    @media (min-width: 701px) and (max-width: 900px) {
      .devmind-section {
        padding: 40px 25px;
      }
    }

    .dm-social {
      min-width: 2em;
      max-width: 2em;
      width: 2em;
      height: 2em;
    }
  </style>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setCookieDomain", "*.dev-mind.fr"]);
    _paq.push(["disableCampaignParameters"]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="https://devmind.matomo.cloud/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src='https://cdn.matomo.cloud/devmind.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->
<style>.dm-block--blog{width:100%;background-color:#eceff1;color:#424242;padding:0;margin:0}.dm-block--blog a,.dm-block--blog a:hover,.dm-block--blog a:visited{font-weight:700;color:#424242;text-decoration:none}footer{background-color:#424242}.is-small-screen{display:none}.is-large-screen{display:inherit}@media screen and (max-width: 900px){.is-small-screen{display:inherit}.is-large-screen{display:none}}h1,h2{color:#424242;font-weight:100}h1{font-weight:bolder;font-size:35px;line-height:38px}h2{font-size:25px;line-height:28px}.small{font-size:small}@media (max-width: 700px){h1{font-size:28px;line-height:30px}h2{font-size:22px;line-height:24px}}
</style><link rel="stylesheet" href="styles-WO7TV6DC.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles-WO7TV6DC.css"></noscript><style ng-app-id="ng">.dm_footer[_ngcontent-ng-c2660501952]{color:#eee;display:flex;justify-content:space-between;font-size:14px}.dm_footer[_ngcontent-ng-c2660501952]   .dm_society[_ngcontent-ng-c2660501952]{color:#fff}.dm_footer[_ngcontent-ng-c2660501952]   div[_ngcontent-ng-c2660501952]{margin-right:1em;width:100%}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__middle[_ngcontent-ng-c2660501952]{flex-grow:1}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__right[_ngcontent-ng-c2660501952]{text-align:right}.dm_footer[_ngcontent-ng-c2660501952]   .is-large-screen[_ngcontent-ng-c2660501952]{padding:.7em;margin:.7em 1em}.dm_footer[_ngcontent-ng-c2660501952]   .is-small-screen[_ngcontent-ng-c2660501952]{padding:0;margin:0 1em;font-size:12px}</style><style ng-app-id="ng">h1{margin-top:.5em}.dm-blog--info-date{font-size:smaller;color:#424242;border:1px solid #aaa;border-radius:24px;padding:.5em 1em;margin-right:.5em;display:inline}.blog-keywords{display:flex;margin-bottom:1em}.blog-keywords .dm-blog--keyword-detail{background-color:#ccc;color:#424242;padding:.5em 1em;margin-right:.5em;border-radius:24px;font-size:smaller}.toc{background-color:#ccc;margin-top:1em;border:1px solid #ccc;padding:1em;border-radius:8px}.toc #toctitle{font-weight:700;margin-bottom:.5em}img{max-width:100%;height:auto}.imageblock>.content{display:flex;justify-content:center;align-items:center}.highlight{display:block;overflow-x:auto;background:#f3f3f3;color:#444;padding:1.5em;box-shadow:0 8px 16px #00000026;border-radius:8px}code.hljs{padding:3px 5px}.hljs-comment{color:#697070}.hljs-punctuation,.hljs-tag{color:#444a}.hljs-tag .hljs-attr,.hljs-tag .hljs-name{color:#444}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#ab5656}.hljs-literal{color:#695}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta .hljs-string{color:#38a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.language-kotlin:before{display:block;float:right;content:"kotlin";font-weight:700;text-transform:uppercase}.language-typescript:before{display:block;float:right;content:"typescript";font-weight:700;text-transform:uppercase}.language-java:before{display:block;float:right;content:"java";font-weight:700;text-transform:uppercase}.language-javascript:before{display:block;float:right;content:"javascript";font-weight:700;text-transform:uppercase}.language-shell:before{display:block;float:right;content:"shell";font-weight:700;text-transform:uppercase}.language-yaml:before{display:block;float:right;content:"yaml";font-weight:700;text-transform:uppercase}.language-json:before{display:block;float:right;content:"json";font-weight:700;text-transform:uppercase}.language-xml:before{display:block;float:right;content:"xml";font-weight:700;text-transform:uppercase}.language-html:before{display:block;float:right;content:"html";font-weight:700;text-transform:uppercase}.language-css:before{display:block;float:right;content:"css";font-weight:700;text-transform:uppercase}.language-scss:before{display:block;float:right;content:"scss";font-weight:700;text-transform:uppercase}
</style></head>
<body><!--nghm-->
  <app-root _nghost-ng-c582792440 ng-version="18.0.0" ngh="2" ng-server-context="ssg"><app-header _ngcontent-ng-c582792440 _nghost-ng-c2882497807 ngh="0"><header _ngcontent-ng-c2882497807><div _ngcontent-ng-c2882497807 class="header-img"><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" href="/"><img _ngcontent-ng-c2882497807 src="img/logo/logo_long.svg" alt="Dev-Mind" title="Dev-Mind"></a></div><nav _ngcontent-ng-c2882497807><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" class="nav-home" href="/"><img _ngcontent-ng-c2882497807 src="/img/ic_home_white_24px.svg" rel="start" alt="Accueil"></a><a _ngcontent-ng-c2882497807 routerlink="/formations.html" aria-label="Formations" class href="/formations.html"> Formations</a><a _ngcontent-ng-c2882497807 routerlink="/blog.html" aria-label="Blog" class="active" href="/blog.html">Blog</a><a _ngcontent-ng-c2882497807 routerlink="/experience.html" aria-label="Experience" class href="/experience.html"> Expérience</a></nav><hr _ngcontent-ng-c2882497807></header><div _ngcontent-ng-c2882497807 class="header-space"></div></app-header><router-outlet _ngcontent-ng-c582792440></router-outlet><app-asciidoc-viewer ngh="1"><div class="dm-block--blog"><div class="devmind-section"><h1><!--ngetn--></h1><div class="blog-keywords"><div class="dm-blog--info-date">02/11/2018</div><div class="dm-blog--keyword-detail">Web</div><div class="dm-blog--keyword-detail">Clever</div><div class="dm-blog--keyword-detail">Cloud</div><!---->&nbsp; </div><div class="preview"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Une application web est constituée de ressources, d’images, de fichiers JavaScript, de feuilles de styles…​ Pour pouvoir répondre à des requêtes HTTP nous avons besoin d’un serveur Web. Les plus connus sont peut être <a href="http://httpd.apache.org/">Apache</a> et <a href="http://nginx.org/">nginx</a>. Souvent, nous avons besoin de coupler à nos sites, une application côté serveur (pour gérer la sécurité, stocker des données, lancer des traitements…​). Nous devons mettre en place un serveur d’application, qui jouera double rôle : serveur web gérant les ressources statiques et application effectuant des actions et générant des réponses à la volée en fonction des actions utilisateurs.</p>
</div>
<div class="paragraph">
<p>Dans cet article, j’explique comment écrire ce serveur en JS et comment déployer le tout sur <a href="https://www.clever-cloud.com">Clever Cloud</a>. Vous pouvez voir un exemple concret avec mon <a href="https://github.com/Dev-Mind/dev-mind.fr">site web</a>. Nous verrons également les aspects  sécurité et optimisation des performances.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2018/objectif_clever_cloud_00.png" alt="Conférence">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serveur_application_javascript">Serveur application JavaScript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le JavaScript s’exécute sur une machine virtuelle qui est présente dans votre navigateur Internet. Quand on fait du JavaScript côté serveur, nous avons aussi besoin d’une machine virtuelle JavaScript. Nous pouvons utiliser la plateforme <a href="https://nodejs.org">Node.js</a> qui se base sur le moteur <a href="https://v8.dev/">V8</a> de Google Chrome. Il fournit également plusieurs librairies pour répondre aux besoins des développeurs côté serveur. Nous avons notamment l’intégration de la librairie <a href="https://nodejs.org/api/http.html">http</a> qui permet de gérer un serveur Web</p>
</div>
<div class="paragraph">
<p>Le code suivant permet de lancer un serveur sur le port 8080 et d’afficher un message <code>HelloWorld</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">//create a server object which listens on port 8080</span>
http.<span class="hljs-title function_">createServer</span>((req, res) =&amp;gt; {
  <span class="hljs-comment">//write a response to the client</span>
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'Hello World!'</span>);
  <span class="hljs-comment">//end the response</span>
  res.<span class="hljs-title function_">end</span>();
}).<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour lancer ce script (appelé par exemple <code>app.js</code>) vous pouvez lancer la commande et ensuite ouvrir http:localhost:8080 dans votre navigateur Internet</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell">node app.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le module <a href="https://nodejs.org/api/http.html">http</a> est un peu minimaliste. Quand nous voulons écrire une application nous avons besoin de plus de fonctionnalités. <a href="http://expressjs.com/">Express JS</a> fournit plusieurs utilitaires pour</p>
</div>
<div class="ulist">
<ul>
<li>
<p>étendre ce serveur <a href="https://nodejs.org/api/http.html">http</a>  de base</p>
</li>
<li>
<p>ajouter des routes et exécuter un traitement en fonction de cette route</p>
</li>
<li>
<p>servir des ressources statiques</p>
</li>
<li>
<p>facilement exécuter des traitements sur les requêtes entrantes et sortantes. En Java dans le monde des servlets, nous parlons de <code>filters</code>. En express nous utilisons plutôt le terme de <code>middlewares</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modifiez le premier exemple de cette manière</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-title function_">express</span>()
  .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, (req, res) =&amp;gt; res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello World!'</span>)) <span class="hljs-comment">// (1)</span>
  .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:userName'</span>, (req, res) =&amp;gt; res.<span class="hljs-title function_">send</span>(`<span class="hljs-title class_">Hello</span> ${req.<span class="hljs-property">params</span>.<span class="hljs-property">userName</span>}!`)) <span class="hljs-comment">// (2)</span>
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8085</span>); <span class="hljs-comment">// (3)</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>(1). le message <code>Hello World!</code> s’affiche quand vous lancez <code><a href="http://localhost:8085" class="bare">http://localhost:8085</a></code></p>
</li>
<li>
<p>(2). on peut récupérer des élements dans la route spécifiée. Ici on affichera <code>Hello Guillaume!</code> quand <code><a href="http://localhost:8085/users/Guillaume" class="bare">http://localhost:8085/users/Guillaume</a></code> sera utilisée</p>
</li>
<li>
<p>(3). permet de spécifier le port d’écoute</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si vous voulez servir un répertoire contenant des ressources statiques (ressources CSS, JS, HTML…​) vous pouvez ajouter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript">.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(`build/dist`))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comment_assurer_les_performances_de_son_serveur_web">Comment assurer les performances de son serveur web</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous venons de voir comment paramétrer un serveur JS de base. Mais si vous voulez mettre votre application en production vous allez devoir en faire plus.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Si vous n’êtes pas familier avec les performances d’une application Web vous pouvez suivre <a href="https://www.dev-mind.fr/formation_optimiser.html">la formation Dev-Mind</a> ou suivre la vidéo de mon intervention à <a href="https://www.youtube.com/watch?time_continue=2&amp;v=9PRPPJFaF_o">Devoxx 2017</a>.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_mesurer_les_performances">Mesurer les performances</h3>
<div class="paragraph">
<p>Si vous utilisez Chrome, vous pouvez utiliser Lighthouse qui est intégré aux ChromeDevTools (Ctrl+Shift+I)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2018/objectif_clever_cloud_01.png" alt="Lighthouse">
</div>
</div>
<div class="paragraph">
<p>Lighthouse va analyser votre site sur mobile ou desktop et vous proposer des rapports de performance. Il vous indique ce qui est bon ou moins bon, et propose des chemins de résolution quand des problèmes sont détectés. Par exemple</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2018/objectif_clever_cloud_02.png" alt="Rapport Lighthouse">
</div>
</div>
<div class="paragraph">
<p>Il existe d’autres outils en ligne comme <a href="https://developers.google.com/speed/pagespeed/insights/">PageSpeed</a>, <a href="https://www.webpagetest.org/">WebpageTest</a>…​</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_compression">La compression</h3>
<div class="paragraph">
<p>Le plus gros problème sur un site web est la taille des ressources. La taille moyenne des ressources utilisées sur une page, ne fait que grossir depuis des années. Pour limiter la quantité de données à envoyer, vous pouvez faire de la compression. Les pages HTML, CSS ou JS sont écrites au format texte qui est facilement compressable. De plus tous les navigateurs aujourd’hui acceptent des ressources compressées.</p>
</div>
<div class="paragraph">
<p>Pour activer la compression avec express.js, vous pouvez utiliser le middleware  <a href="https://www.npmjs.com/package/compression">compression</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression'</span>);

<span class="hljs-title function_">express</span>()
  .<span class="hljs-title function_">use</span>(<span class="hljs-title function_">compression</span>())
  .<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(`build/dist`))
  .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, (req, res) =&amp;gt; res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello World!'</span>))
  .<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:userName'</span>, (req, res) =&amp;gt; res.<span class="hljs-title function_">send</span>(`<span class="hljs-title class_">Hello</span> ${req.<span class="hljs-property">params</span>.<span class="hljs-property">userName</span>}!`))
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8085</span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_le_cache">Le cache</h3>
<div class="paragraph">
<p>Comme le dit <a href="https://twitter.com/addyosmani">Addy Osmani</a>, la ressource web la plus optimisée est celle que l’on ne transfert pas du serveur au client web. Pour mettre en place cette magie, vous devez activer le cache de ressources, et donner des informations au navigateur sur la durée de validité de chaque fichier.</p>
</div>
<div class="paragraph">
<p>Voici par exemple la configuration utilisée sur mon site</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> nocache = (res) =&amp;gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'private, no-cache, no-store, must-revalidate'</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Expires'</span>, <span class="hljs-string">'-1'</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Pragma'</span>, <span class="hljs-string">'no-cache'</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_MIDDLEWARE</span> = (res, path) =&amp;gt; {
  <span class="hljs-keyword">switch</span>(serveStatic.<span class="hljs-property">mime</span>.<span class="hljs-title function_">lookup</span>(path)){
    <span class="hljs-keyword">case</span> <span class="hljs-string">'application/xhtml+xml'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'text/html'</span>:
      <span class="hljs-title function_">nocache</span>(res);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'text/javascript'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'application/x-javascript'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'application/javascript'</span>:
      <span class="hljs-keyword">if</span>(path.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'sw.js'</span>) &amp;gt;= <span class="hljs-number">0</span>){
        <span class="hljs-title function_">nocache</span>(res);
      }
      <span class="hljs-keyword">else</span>{
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'private, max-age=14400'</span>);
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'text/css'</span>:
      <span class="hljs-keyword">if</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'prod'</span>){
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'private, max-age=14400'</span>);
      }
      <span class="hljs-keyword">else</span>{
        <span class="hljs-title function_">nocache</span>(res);
      }
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/gif'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/jpg'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/jpeg'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/png'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/tiff'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/svg+xml'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/webp'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/vnd.microsoft.icon'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/icon'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/ico'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'image/x-ico'</span>:
      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'public, max-age=691200'</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-attr">default</span>:
  }
};</code></pre>
</div>
</div>
<div class="olist arabic small">
<ol class="arabic">
<li>
<p>il est important de ne pas mettre vos pages HTML en cache. Une page HTML est le point d’entrée de votre site et il est important que les utilisateurs puissent charger les dernières versions. Contrairement aux autres ressources, avec lesquelles vous pouvez faire du cache busting, le nom des pages HTML doit être fixe. Si ce n’est pas le cas, les robotos ne pourront pas indexé votre site. Pour optimiser le chargement vous pouvez passer par les services workers</p>
</li>
<li>
<p>pour le JS vous pouvez mettre une durée de cache de quelques heures. Par contre il est important de ne pas mettre de cache sur votre fichier de configuration des services workers. Ce fichier est très sensible et il vaut mieux que le navigateur essaie de le recharger tout le temps afin de récupérer les dernières mises à jour. Les services workers viennent avec un autre système de cache</p>
</li>
<li>
<p>en production plusieurs optimisations sont faites quand la variable d’environnement <code>NODE_ENV</code> a la valeur <code>prod</code>. Dans mon cas j’ajoute un cache sur les ressources CSS</p>
</li>
<li>
<p>pour les images vous pouvez mettre une durée de cache plus longue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Avec Express.js vous pouvez indiquer dans la configuration, l’emplacement de vos ressources statiques et indiquer la politique de cache. Dans mon cas elles sont dans <code>build/dist</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript">.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(`build/dist`, {<span class="hljs-attr">setHeaders</span>: <span class="hljs-variable constant_">CACHE_MIDDLEWARE</span>}))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_autres_optimisations">Autres optimisations</h3>
<div class="paragraph">
<p>Pour plus d’informations vous pouvez suivre la <a href="http://expressjs.com/fr/advanced/best-practice-performance.html">page dédiée aux performances</a> de express.js. Vous pouvez aussi mettre en place des services workers. Si vous ne savez pas comment faire, vous pouvez suivre <a href="https://www.dev-mind.fr/blog/2017/workboxjs.html">cet article</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comment_sécuriser_son_serveur_web">Comment sécuriser son serveur web</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_connaître_les_problèmes">Connaître les problèmes</h3>
<div class="paragraph">
<p>Comme pour les performances, avant de faire quelque chose, il faut savoir qu’elles sont les problèmes de votre site. Je vous conseille d’utiliser le site de Mozilla <a href="https://observatory.mozilla.org/" class="bare">https://observatory.mozilla.org/</a>. Cet outil en ligne parse votre site et vérifie le paramétrage</p>
</div>
<div class="ulist">
<ul>
<li>
<p>des redirections</p>
</li>
<li>
<p>des cookies</p>
</li>
<li>
<p>de l’HTTPS</p>
</li>
<li>
<p>des différents headers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il existe plusieurs solutions pour simplifier cette configuration. Je suis parti sur le middleware <a href="https://github.com/helmetjs/helmet">helmet</a> qui</p>
</div>
<div class="ulist">
<ul>
<li>
<p>contrôle la prélecture DNS du navigateur (<a href="https://helmetjs.github.io/docs/dns-prefetch-control">dnsPrefetchControl</a>)</p>
</li>
<li>
<p>prémunit votre site du clickjacking (<a href="https://helmetjs.github.io/docs/frameguard/">frameguard</a>)</p>
</li>
<li>
<p>supprime l’en-tête X-Powered-By (<a href="https://helmetjs.github.io/docs/hide-powered-by">hidePoweredBy</a>)</p>
</li>
<li>
<p>contrôle HTTPS (<a href="https://helmetjs.github.io/docs/hsts/">hsts</a>)</p>
</li>
<li>
<p>définit les options de téléchargement pour IE8 (<a href="https://helmetjs.github.io/docs/ienoopen">ieNoOpen</a>)</p>
</li>
<li>
<p>empêche les clients de renifler le type MIME (<a href="https://helmetjs.github.io/docs/dont-sniff-mimetype">noSniff</a>)</p>
</li>
<li>
<p>ajoute quelques petites protections XSS (<a href="https://helmetjs.github.io/docs/xss-filter">xssFilter</a>)</p>
</li>
<li>
<p>…​</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Par exemple</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'helmet'</span>);

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SECURITY_POLICY</span> = {
  <span class="hljs-attr">directives</span>: {
    <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">"'self'"</span>],
    <span class="hljs-comment">// We have to authorize inline CSS used to improve firstload</span>
    <span class="hljs-attr">styleSrc</span>: [<span class="hljs-string">"'unsafe-inline'"</span>, <span class="hljs-string">"'self'"</span>],
    <span class="hljs-comment">// We have to authorize data:... for SVG images</span>
    <span class="hljs-attr">imgSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">'data:'</span>, <span class="hljs-string">'https:'</span>],
    <span class="hljs-comment">// We have to authorize inline script used to load our JS app</span>
    <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>, <span class="hljs-string">'https://www.google-analytics.com/analytics.js'</span>,
      <span class="hljs-string">"https://storage.googleapis.com/workbox-cdn/*"</span>,
      <span class="hljs-string">"https://storage.googleapis.com/workbox-cdn/releases/3.6.3/workbox-core.prod.js"</span>]
  }
};

<span class="hljs-title function_">express</span>()
  .<span class="hljs-title function_">use</span>(<span class="hljs-title function_">helmet</span>())
  .<span class="hljs-title function_">use</span>(helmet.<span class="hljs-title function_">contentSecurityPolicy</span>(<span class="hljs-variable constant_">SECURITY_POLICY</span>))
  <span class="hljs-comment">// Reste de la config</span>
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8085</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez et vous devez encore aller plus loin. Si vous utilisez de l’authentification vous devez préciser comment les cookies seront gérés lorsqu’une session sera ouverte</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
  .<span class="hljs-title function_">enable</span>(<span class="hljs-string">'trust proxy'</span>)
  .<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>({
      <span class="hljs-attr">secret</span>: <span class="hljs-string">'zezaeazezaeza'</span>,
      <span class="hljs-comment">// A session life is 3h</span>
      <span class="hljs-attr">duration</span>: <span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
      <span class="hljs-comment">// We don't authorize a session resave</span>
      <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-comment">// Secured cookies are only set in production</span>
      <span class="hljs-attr">cookie</span>: {
        <span class="hljs-attr">secure</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'prod'</span>,
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
        <span class="hljs-attr">sameSite</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-comment">// User by default is empty</span>
      <span class="hljs-attr">user</span>: {}
    })
  <span class="hljs-comment">// Reste de la config</span>
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8085</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez aussi réorienter les utilisateurs qui n’utilisent pas le HTTPS, paramétrer le CORS, ouvrir une page 404 quand un utilisateur essaye d’accéder à une mauvaise ressource</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
  .<span class="hljs-title function_">enable</span>(<span class="hljs-string">'trust proxy'</span>)
  <span class="hljs-comment">// Reorientation pour ceux qui ne font pas de HTTPS</span>
  .<span class="hljs-title function_">use</span>((req, res, next) =&amp;gt; {
         <span class="hljs-keyword">const</span> httpInForwardedProto = req.<span class="hljs-property">headers</span> &amp;amp;&amp;amp; req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-proto'</span>] &amp;amp;&amp;amp; req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-proto'</span>] === <span class="hljs-string">'http'</span>;
         <span class="hljs-keyword">const</span> httpInReferer = req.<span class="hljs-property">headers</span> &amp;amp;&amp;amp; req.<span class="hljs-property">headers</span>.<span class="hljs-property">referer</span> &amp;amp;&amp;amp; req.<span class="hljs-property">headers</span>.<span class="hljs-property">referer</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'http://'</span>) &amp;gt;=<span class="hljs-number">0</span>;
         <span class="hljs-keyword">const</span> isHtmlPage = req.<span class="hljs-property">url</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">".html"</span>) &amp;gt;= <span class="hljs-number">0</span>;

         <span class="hljs-keyword">if</span>((isHtmlPage || req.<span class="hljs-property">url</span> === <span class="hljs-string">'/'</span>)  &amp;amp;&amp;amp; (httpInForwardedProto || httpInReferer)){
           <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User is not in HTTP, he is redirected'</span>);
           res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">'https://dev-mind.fr'</span> + req.<span class="hljs-property">url</span>);
         }
         <span class="hljs-keyword">else</span>{
           <span class="hljs-title function_">next</span>();
         }
     })
  <span class="hljs-comment">// Paramétrage CORS</span>
  <span class="hljs-title function_">use</span>((req, res, next) =&amp;gt; {
          res.<span class="hljs-title function_">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>);
          res.<span class="hljs-title function_">header</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Origin, X-Requested-With, Content-Type, Accept'</span>);
          <span class="hljs-title function_">next</span>();
        })
  <span class="hljs-comment">// Reste de la config</span>
  <span class="hljs-comment">// En dernier on dit que pour toutes les autres requêtes on ouvre une page 404</span>
  .<span class="hljs-title function_">all</span>(<span class="hljs-string">'*'</span>, (req, res) =&amp;gt; res.<span class="hljs-title function_">redirect</span>(`/<span class="hljs-number">404.</span>html`));
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8085</span>);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_déployer_sur_clever_cloud">Déployer sur Clever Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que notre application fonctionne, nous pouvons la déployer sur clever cloud. Pour celà vous devez identifier les scripts qui seront lancés par la plateforme dans le fichier <code>package.json</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"dev-mind.com"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"install"</span>: <span class="hljs-string">"gulp"</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"node app.js"</span>,
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"gulp serve"</span>
  },
  <span class="hljs-string">"dependencies"</span>: { }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sur Clever Cloud vous deveez créer une application Node.js</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2018/objectif_clever_cloud_03.png" alt="Node JS">
</div>
</div>
<div class="paragraph">
<p>Vous n’avez qu’à suivre les instructions par contre il est important de paramétrer les variables d’environnement suivantes</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript"><span class="hljs-variable constant_">NODE_BUILD_TOOL</span>=yarn
<span class="hljs-variable constant_">NODE_ENV</span>=prod
<span class="hljs-variable constant_">PORT</span>=<span class="hljs-number">8080</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>La première ligne permet d’indiquer à la plateforme que vous utilisez Yarn plutôt que Npm pour charger les dépendances Node.</p>
</li>
<li>
<p>Vous devez ensuite activer le mode <code>prod</code> et</p>
</li>
<li>
<p>démarrer votre application sur le port 8080. Si vous n’utilisez pas ce port votre application ne fonctionnera pas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voila c’est à vous de jouer…​</p>
</div>
</div>
</div></div></div></div></app-asciidoc-viewer><!----><app-footer _ngcontent-ng-c582792440 _nghost-ng-c2660501952 ngh="0"><footer _ngcontent-ng-c2660501952><div _ngcontent-ng-c2660501952 class="dm_footer"><div _ngcontent-ng-c2660501952 class="is-small-screen"><p _ngcontent-ng-c2660501952 id="footer-dm_society"> SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i><br _ngcontent-ng-c2660501952> SIREN : 808 720 759, au RCS de Saint-Etienne<br _ngcontent-ng-c2660501952> All right reserved - ©2024 Guillaume EHRET </p></div><div _ngcontent-ng-c2660501952 class="is-large-screen"><div _ngcontent-ng-c2660501952 class="dm_footer__middle"><div _ngcontent-ng-c2660501952 class="dm_society"> Dev-Mind </div><div _ngcontent-ng-c2660501952>SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i></div><div _ngcontent-ng-c2660501952>SIREN : 808 720 759, au RCS de Saint-Etienne</div><div _ngcontent-ng-c2660501952><small _ngcontent-ng-c2660501952>Mise à jour le 28/05/2024</small></div></div><div _ngcontent-ng-c2660501952 class="dm_footer__right"> All right reserved - ©2024 Guillaume EHRET </div></div></div></footer></app-footer></app-root>

<script src="polyfills-A7MJM4D4.js" type="module"></script><script src="main-KJW7O4OZ.js" type="module"></script>

<script id="ng-state" type="application/json">{"__nghData__":[{},{"t":{"7":"t6"},"c":{"7":[{"i":"t6","r":1,"x":3}]}},{"c":{"1":[{"i":"c933498719","r":1}]}}]}</script></body></html>