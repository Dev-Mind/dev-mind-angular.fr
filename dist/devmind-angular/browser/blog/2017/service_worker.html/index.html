<!DOCTYPE html><html lang="en" data-critters-container><head>
  <meta charset="utf-8">
  <title>Blog</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      min-height: 100vh;
      max-height: 100vh;
      font-family: "Helvetica", "Arial", "sans-serif";
      padding: 0;
      margin: 0;
    }

    header {
      height: 90px;
      max-height: 90px;
      box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      background-color: white;
      display: -webkit-flex;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 99;
      transition-duration: 0.2s;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-property: max-height, box-shadow;
      position: fixed;
      width: 100%;
      text-align: center;
    }
    header hr {
      width:100%;
      background-color: #424242;
      border-color: #424242;
      display: block;
      border: 0;
      height: 0.5em;
      margin: 0;
    }
    .header-img {
      margin: auto;
      width: 50%;
      padding-top: 0.5em;
      height: 30px;
    }
    .header-img img {
      max-height: 30px !important;
    }
    .header-space {
      min-height: 90px;
    }


    @media screen and (min-width: 901px) {
      header {
        height: 120px;
        max-height: 120px;
      }
      .header-img {
        height: 60px;
      }
      .header-img img {
        max-height: 60px !important;
      }
      .header-space {
        min-height: 120px;
      }
      nav a {
        padding: 6px 24px;
      }
      .nav-home{
        display: block !important;
      }
    }


    nav {
      display: -webkit-flex;
      display: flex;
      margin: auto;
    }

    nav a {
      padding: 0 12px;
      line-height: 28px;
      height: 28px;
      color: #424242;
      margin: auto;
      text-decoration: none;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 13px;
      border-radius: 4px;
    }
    .nav-home{
      display: none;
    }
    nav a > img {
    // height: 20px;
    }

    nav a:hover {
      background-color: #9e9e9e;
    }

    nav .active {
      background-color: rgba(0, 0, 0, 0.14);
    }

    main {
      overflow-x: hidden;
    }

    img, picture {
      max-width: 100%;
      height: auto;
      margin: auto;
    }

    * {
      box-sizing: border-box; /* pour maîtriser width et flex-basis */
    }

    .devmind-section {
      display: block;
      margin: 0 auto;
      max-width: 1600px;
      padding: 60px 40px;
    }

    @media (max-width: 700px) {
      .devmind-section {
        padding: 25px 10px;
      }
    }

    @media (min-width: 701px) and (max-width: 900px) {
      .devmind-section {
        padding: 40px 25px;
      }
    }

    .dm-social {
      min-width: 2em;
      max-width: 2em;
      width: 2em;
      height: 2em;
    }
  </style>
  <script>
    function copyToClipboard(id) {
      const text = document.getElementById(id).innerText
        .replaceAll('~$', '')
        .replaceAll('(1)', '')
        .replaceAll('(2)', '')
        .replaceAll('(3)', '')
        .replaceAll('(4)', '')
        .replaceAll('(5)', '')
        .replaceAll('(6)', '')
        .replaceAll('(7)', '')
        .replaceAll('(8)', '')
        .replaceAll('(9)', '')
        .replaceAll('(10)', '')
      ;
      navigator.clipboard.writeText(text.substring(0, text.length));
    }
  </script>
<style>code[class*=language-]{color:#555;background:none;text-shadow:0 1px white;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.imageblock{text-align:center}h1,h2{font-weight:100}h1{font-size:35px;line-height:38px}.dm-block--blog{width:100%;background-color:#eceff1;color:#424242;padding:0;margin:0}.dm-block--blog a,.dm-block--blog a:hover,.dm-block--blog a:visited{font-weight:700;color:#424242;text-decoration:none;cursor:pointer}.dm-block--blog a:hover{color:#424242;text-decoration:underline}.btn-copy-code{background-color:#fff;border:2px solid white;border-radius:24px;color:#424242!important;margin:1em .5em auto auto;font-weight:700;font-size:16px;display:block;cursor:pointer;width:auto;text-align:center;box-shadow:0 4px 5px #00000024,0 1px 10px #0000001f,0 2px 4px -1px #0003;padding:4px;font-size:small}.btn-copy-code:hover{background-color:#424242;border:2px solid #424242;color:#fff!important;padding:.5em 1em}footer{background-color:#424242}.is-small-screen{display:none}.is-large-screen{display:inherit}@media screen and (max-width: 900px){.is-small-screen{display:inherit}.is-large-screen{display:none}}h1,h2{color:#424242;font-weight:100}h1{font-weight:bolder;font-size:35px;line-height:38px}h2{font-size:25px;line-height:28px}@media (max-width: 700px){h1{font-size:28px;line-height:30px}h2{font-size:22px;line-height:24px}}
</style><link rel="stylesheet" href="styles-F67ARFNE.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles-F67ARFNE.css"></noscript><style ng-app-id="ng">.dm_footer[_ngcontent-ng-c2660501952]{color:#eee;display:flex;justify-content:space-between;font-size:14px}.dm_footer[_ngcontent-ng-c2660501952]   .dm_society[_ngcontent-ng-c2660501952]{color:#fff}.dm_footer[_ngcontent-ng-c2660501952]   div[_ngcontent-ng-c2660501952]{margin-right:1em;width:100%}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__middle[_ngcontent-ng-c2660501952]{flex-grow:1}.dm_footer[_ngcontent-ng-c2660501952]   .dm_footer__right[_ngcontent-ng-c2660501952]{text-align:right}.dm_footer[_ngcontent-ng-c2660501952]   .is-large-screen[_ngcontent-ng-c2660501952]{padding:.7em;margin:.7em 1em}.dm_footer[_ngcontent-ng-c2660501952]   .is-small-screen[_ngcontent-ng-c2660501952]{padding:0;margin:0 1em;font-size:12px}</style><style ng-app-id="ng">h1{margin-top:.5em}.dm-blog--info-date{font-size:smaller;color:#424242;border:1px solid #aaa;border-radius:24px;padding:.5em 1em;margin-right:.5em;display:inline}.blog-keywords{display:flex;margin-bottom:1em}.blog-keywords .dm-blog--keyword-detail{background-color:#ccc;color:#424242;padding:.5em 1em;margin-right:.5em;border-radius:24px;font-size:smaller}.toc{background-color:#ccc;margin-top:1em;border:1px solid #ccc;padding:1em;border-radius:8px}.toc #toctitle{font-weight:700;margin-bottom:.5em}img{max-width:100%;height:auto}.imageblock>.content{display:flex;justify-content:center;align-items:center}.highlight{display:block;overflow-x:auto;background:#f3f3f3;color:#444;padding:1.5em;box-shadow:0 8px 16px #00000026;border-radius:8px}code.hljs{padding:3px 5px}.hljs-comment{color:#697070}.hljs-punctuation,.hljs-tag{color:#444a}.hljs-tag .hljs-attr,.hljs-tag .hljs-name{color:#444}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#ab5656}.hljs-literal{color:#695}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta .hljs-string{color:#38a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.language-kotlin:before{display:block;float:right;content:"kotlin";font-weight:700;text-transform:uppercase}.language-typescript:before{display:block;float:right;content:"typescript";font-weight:700;text-transform:uppercase}.language-java:before{display:block;float:right;content:"java";font-weight:700;text-transform:uppercase}.language-javascript:before{display:block;float:right;content:"javascript";font-weight:700;text-transform:uppercase}.language-shell:before{display:block;float:right;content:"shell";font-weight:700;text-transform:uppercase}.language-yaml:before{display:block;float:right;content:"yaml";font-weight:700;text-transform:uppercase}.language-json:before{display:block;float:right;content:"json";font-weight:700;text-transform:uppercase}.language-xml:before{display:block;float:right;content:"xml";font-weight:700;text-transform:uppercase}.language-html:before{display:block;float:right;content:"html";font-weight:700;text-transform:uppercase}.language-css:before{display:block;float:right;content:"css";font-weight:700;text-transform:uppercase}.language-scss:before{display:block;float:right;content:"scss";font-weight:700;text-transform:uppercase}
</style></head>
<body><!--nghm-->
  <app-root _nghost-ng-c582792440 ng-version="18.0.0" ngh="2" ng-server-context="ssg"><app-header _ngcontent-ng-c582792440 _nghost-ng-c2882497807 ngh="0"><header _ngcontent-ng-c2882497807><div _ngcontent-ng-c2882497807 class="header-img"><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" href="/"><img _ngcontent-ng-c2882497807 src="img/logo/logo_long.svg" alt="Dev-Mind" title="Dev-Mind"></a></div><nav _ngcontent-ng-c2882497807><a _ngcontent-ng-c2882497807 routerlink="/" aria-label="Accueil" class="nav-home" href="/"><img _ngcontent-ng-c2882497807 src="/img/ic_home_white_24px.svg" rel="start" alt="Accueil"></a><a _ngcontent-ng-c2882497807 routerlink="/formations.html" aria-label="Formations" class href="/formations.html"> Formations</a><a _ngcontent-ng-c2882497807 routerlink="/blog.html" aria-label="Blog" class="active" href="/blog.html">Blog</a><a _ngcontent-ng-c2882497807 routerlink="/experience.html" aria-label="Experience" class href="/experience.html"> Expérience</a></nav><hr _ngcontent-ng-c2882497807></header><div _ngcontent-ng-c2882497807 class="header-space"></div></app-header><router-outlet _ngcontent-ng-c582792440></router-outlet><app-asciidoc-viewer ngh="1"><div class="dm-block--blog"><div class="devmind-section"><h1><!--ngetn--></h1><div class="blog-keywords"><div class="dm-blog--info-date">20/06/2017</div><div class="dm-blog--keyword-detail">Web</div><div class="dm-blog--keyword-detail">PWA</div><div class="dm-blog--keyword-detail">ServiceWorker</div><!---->&nbsp; </div><div class="preview"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Si vous suivez l’actualité Dev-Mind (<a href="https://www.dev-mind.fr/formation_optimiser.html">formation</a> ou <a href="https://www.dev-mind.fr/experience.html#conferences">conférence</a> sur les performances web), j’ai introduit à plusieurs occasions le concept des <a href="https://developers.google.com/web/progressive-web-apps/">progressive webaps</a> et des <a href="https://developer.mozilla.org/fr/docs/Web/API/Service_Worker_API">service workers</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2017/service_worker_00.png" alt="Services workers">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_progressive_webapp_et_service_worker">Progressive Webapp et service worker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Revenons un peu à la base si vous ne connaissez pas ces termes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les <strong>progressive webapps</strong> (PWA) sont un concept poussé par Google. Le but est de pousser les développeurs à créer des applications web modernes facilitant la navigation des utilisateurs. Les évolutions des standards du web, font que les applications proposées au sein d’un navigateur se rapprochent de plus en plus, de ce que l’on peut faire avec des applications natives. Une application web, doit s’adapter aux tailles des écrans des utilisateurs, être rapide à charger, doit marcher quand le réseau est faible ou inexistant, doit pouvoir faire des notifications sur un téléphone…​</p>
</li>
<li>
<p>Les <strong>services workers</strong> sont un moyen technique pour arriver à mettre en place certains concepts d’une progressive webapp comme le fonctionnement hors ligne ou sur un réseau défaillant. Il n’y a pas de magie, les services workers permettent simplement de recharger les données déjà chargées et qui ont été persistées dans un cache local. Les services workers permettent de faire ce travail de l’ombre et de charger en tâche de fond les ressources dont vous avez besoin sur votre site et de les servir pour améliorer les performances ou lorsque vous n’avez pas de réseau.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Je vais revenir un peu plus en détail sur les services workers juste après mais il est important de savoir que toutes ses fonctionalités peuvent aujourd’hui être mises en place dans les navigateurs modernes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2017/service_worker_01.png" alt="Can I Use service worker">
</div>
</div>
<div class="paragraph">
<p>Gros bémol pour Safari (navigateur Apple) qui traîne à implémenter les normes et qui est aujourd’hui le pire navigateur pour surfer sur le web. Mais ces nouvelles fonctionnalités peuvent tout de même être ajoutées à votre site. Elles ne s’activeront tout simplement pas sur les navigateurs à la traîne. Sur Edge ils ne sont pas encore actifs par défaut mais ça devrait arriver</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_workers">Les workers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tous les navigateurs implémentent aujourd’hui l’API des web workers. Par défaut JavaScript est mono thread et tout s’exécute dans un thread principal. Bien évidemment si vous multipliez les traitements dans cet unique thread vous risquez d’avoir des problèmes de performance. L’api <a href="https://developer.mozilla.org/fr/docs/Utilisation_des_web_workers">Web Worker</a> permet de déporter des traitements dans un thread en arrière plan. Ce thread ne peut pas accéder à toutes les API. Par exemple, vous ne pouvez pas manipuler le DOM, mais vous pouvez utiliser d’autres API comme WebSocket, IndexedDB…​</p>
</div>
<div class="paragraph">
<p>Les échanges entre un worker et votre thread principal ne peut se faire que par échange de messages. Le mieux pour comprendre ce concept est de prendre un exemple. Dans le code ci dessous je déclare un worker dans le thread principal. J’ajoute ensuite un listener qui sera à l’écoute des messages envoyés par le worker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" id="1723541687488.1292"><span class="hljs-comment">// Création du worker</span>
<span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'doWork.js'</span>);

<span class="hljs-comment">// On crée un event listener pour intercepter les messages envoyés par le worker</span>
worker.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker said: '</span>, e.<span class="hljs-property">data</span>);
}, <span class="hljs-literal">false</span>);

<span class="hljs-comment">// Vous pouvez à tout moment envoyé un message au worker</span>
worker.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Hello World'</span>);</code><button class="btn-copy-code" onclick="copyToClipboard('1723541687488.1292')">Copy</button></pre>
</div>
</div>
<div class="paragraph">
<p>Au final le code du worker <em>doWork.js</em> sera</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" id="1723541687488.0522"><span class="hljs-comment">// On crée un listener pour recevoir les messages du thread principal</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>,<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
   <span class="hljs-comment">// la méthode postMessage permet de renvoyer un message</span>
   self.<span class="hljs-title function_">postMessage</span>(e.<span class="hljs-property">data</span>);
}, <span class="hljs-literal">false</span>);</code><button class="btn-copy-code" onclick="copyToClipboard('1723541687488.0522')">Copy</button></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_services_workers">Les services workers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les services workers sont des workers. Il n’ont donc pas d’accès au DOM, et s’exécutent dans une tâche de fond différente de celle du thread principal de votre application. Ils sont donc non-bloquants. Dans un web worker tout est asynchrone et le nombre d’API utilisable est plus restreint.</p>
</div>
<div class="paragraph">
<p>Un service worker peut être vu comme un proxy, qui va se mettre entre votre site et le serveur. Il est capable d’intercepter tous les requêtes qui rentrent ou qui sortent pour les modifier. Les ressources prises en charge par le service worker sont définies dans un fichier de configuration JavaScript.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2017/service_worker_02.png" alt="Service worker = proxy">
</div>
</div>
<div class="paragraph">
<p>Plutôt sensible et critique non ? C’est pourquoi les services workers ne fonctionnent qu’en HTTPS. Le service worker vient aussi avec un cache de ressources. Il faut être vigilant dans votre configuration, si vous ne voulez pas que vos ressources ne soient jamais raffraîchies.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_cycle_de_vie">Le cycle de vie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>L’activation des services workers va se faire en plusieurs étapes que nous allons décrire rapidement.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../img/blog/2017/service_worker_05.png" alt="Cycle de vie">
</div>
</div>
<div class="paragraph">
<p>Quand votre site se charge vous pouvez réserver une section de votre code pour paramétrer le service worker. C’est là que vous pourrez tester que votre navigateur prend bien en charge cette API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" id="1723541687488.8665"><span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator){
    <span class="hljs-comment">// ..</span>
}</code><button class="btn-copy-code" onclick="copyToClipboard('1723541687488.8665')">Copy</button></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>La première étape consiste à enregistrer votre service worker via <code><em>serviceWorkerContainer.register('sw.js')</em></code></p>
</li>
<li>
<p>Si tout se passe bien le service worker (<em>sw.js</em> dans notre exemple) est exécuté dans un thread séparé. Il passe à l’état REGISTERED</p>
</li>
<li>
<p>Une fois que vous essayez d’accéder à une ressource gérée par le service worker, ce dernier va tenter de s’installer. Si tout se passe bien l’événement <code><em>oninstall</em></code> est déclenché. C’est dans ce listener que nous pouvons par exemple utiliser l’API IndexedDB pour mettre en cache nos ressources.</p>
</li>
<li>
<p>Le service worker va ensuite essayé de s’activer en envoyant l’événement <code><em>onactivate</em></code>. Le listener associé est généralement utilisé pour faire le ménage dans le cache et supprimer les ressources qui ne sont plus nécéssaires</p>
</li>
<li>
<p>Les pages qui sont à ce moment ouvertes seront contrôlées par le service worker. Vous pouvez intercepter dans le script de votre service worker les événements <code><em>push</em></code>, <code><em>fetch</em></code> et <code><em>sync</em></code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ecriture_du_service_worker">Ecriture du service worker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous venons de voir comment fonctionnait un service worker. Regardons maintenant comment se passe la mise en place. Pour celà rendez vous dans l’article <a href="https://www.dev-mind.fr/blog/2017/creer_service_worker.html">créer un service worker</a>.</p>
</div>
</div>
</div></div></div></div></app-asciidoc-viewer><!----><app-footer _ngcontent-ng-c582792440 _nghost-ng-c2660501952 ngh="0"><footer _ngcontent-ng-c2660501952><div _ngcontent-ng-c2660501952 class="dm_footer"><div _ngcontent-ng-c2660501952 class="is-small-screen"><p _ngcontent-ng-c2660501952 id="footer-dm_society"> SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i><br _ngcontent-ng-c2660501952> SIREN : 808 720 759, au RCS de Saint-Etienne<br _ngcontent-ng-c2660501952> All right reserved - ©2024 Guillaume EHRET </p></div><div _ngcontent-ng-c2660501952 class="is-large-screen"><div _ngcontent-ng-c2660501952 class="dm_footer__middle"><div _ngcontent-ng-c2660501952 class="dm_society"> Dev-Mind </div><div _ngcontent-ng-c2660501952>SARL au capital de <i _ngcontent-ng-c2660501952>5000€</i></div><div _ngcontent-ng-c2660501952>SIREN : 808 720 759, au RCS de Saint-Etienne</div><div _ngcontent-ng-c2660501952><small _ngcontent-ng-c2660501952>Mise à jour le 13/08/2024</small></div></div><div _ngcontent-ng-c2660501952 class="dm_footer__right"> All right reserved - ©2024 Guillaume EHRET </div></div></div></footer></app-footer></app-root>

<script src="polyfills-A7MJM4D4.js" type="module"></script><script src="main-ING7W5GR.js" type="module"></script>

<script id="ng-state" type="application/json">{"__nghData__":[{},{"t":{"7":"t6"},"c":{"7":[{"i":"t6","r":1,"x":3}]}},{"c":{"1":[{"i":"c490234363","r":1}]}}]}</script></body></html>